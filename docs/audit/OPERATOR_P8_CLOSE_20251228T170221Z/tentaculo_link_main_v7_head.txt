"""
Tentáculo Link v7.0 - Gateway Refactored

Pure proxy + auth + context-7 middleware + modular clients.
Version: 7.0 | Module: tentaculo_link | Port: 8000

Main HTTP gateway for VX11 with token authentication, circuit breaker,
Context-7 sessions, and intelligent request routing to internal services.
"""


import asyncio
import json
import time
import uuid
from pathlib import Path
from typing import Any, Dict, Optional, Set, Union

from contextlib import asynccontextmanager
from fastapi import (
    Depends,
    FastAPI,
    Header,
    HTTPException,
    Request,
    WebSocket,
    WebSocketDisconnect,
)
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import (
    JSONResponse,
    StreamingResponse,
    Response,
    FileResponse,
    RedirectResponse,
)
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel, Field
import httpx

from config.forensics import write_log
from config.settings import settings
from config.tokens import get_token, load_tokens
from config.cache import get_cache, cache_startup, cache_shutdown
from config.cache_config import get_ttl, cache_decorator
from config.rate_limit import get_rate_limiter, set_redis_for_limiter
from config.metrics_prometheus import get_prometheus_metrics
from tentaculo_link.clients import get_clients
from tentaculo_link.context7_middleware import get_context7_manager

# Load environment tokens
load_tokens()
VX11_TOKEN = (
    get_token("VX11_TENTACULO_LINK_TOKEN")
    or get_token("VX11_GATEWAY_TOKEN")
    or settings.api_token
)
AUTH_HEADERS = {settings.token_header: VX11_TOKEN}


def _resolve_files_dir() -> Path:
    """Find writable directory for uploads."""
    candidates = [
        Path(settings.DATA_PATH) / "tentaculo_link" / "files",
        Path("/tmp/tentaculo_link/files"),
    ]
    for path in candidates:
        try:
            path.mkdir(parents=True, exist_ok=True)
            return path
        except PermissionError:
            continue
    return candidates[-1]


FILES_DIR = _resolve_files_dir()


class TokenGuard:
    """Token validation dependency."""

    def __call__(self, x_vx11_token: str = Header(None)) -> bool:
        if settings.enable_auth:
            if not x_vx11_token:
                raise HTTPException(status_code=401, detail="auth_required")
            if x_vx11_token != VX11_TOKEN:
                raise HTTPException(status_code=403, detail="forbidden")
        return True


token_guard = TokenGuard()


class OperatorChatRequest(BaseModel):
    """Chat message with session context."""

    message: str
    session_id: Optional[str] = None
    user_id: Optional[str] = "local"
    metadata: Optional[Dict[str, Any]] = None


class OperatorChatResponse(BaseModel):
    """Chat response."""

    session_id: str
    response: str
    metadata: Optional[Dict[str, Any]] = None


class OperatorTaskRequest(BaseModel):
    """TASK/ANALYSIS request routed via Switch."""

    task_type: str
    payload: Dict[str, Any]
    intent_type: Optional[str] = "task"
    session_id: Optional[str] = None
    user_id: Optional[str] = "local"
    metadata: Optional[Dict[str, Any]] = None
    provider_hint: Optional[str] = None


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Startup/shutdown lifecycle."""
    clients = get_clients()
    context7 = get_context7_manager()
    cache = get_cache()
    limiter = get_rate_limiter()
    metrics = get_prometheus_metrics()

    await clients.startup()
    await cache_startup()  # Initialize Redis cache

    # Link Redis to rate limiter
    if cache.redis:
        set_redis_for_limiter(cache.redis)

    FILES_DIR.mkdir(parents=True, exist_ok=True)
    write_log(
        "tentaculo_link", "startup:v7_initialized (with cache+rate_limit+metrics)"
    )

    # Yield to allow app to run
    yield

    # Shutdown
    await clients.shutdown()
    await cache_shutdown()
    write_log("tentaculo_link", "shutdown:v7_complete")


# Create app
app = FastAPI(
    title="VX11 Tentáculo Link",
    version="7.0",
    lifespan=lifespan,
)

# Add CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Mount Operator UI static files
operator_ui_path = Path(__file__).parent.parent / "operator" / "frontend" / "dist"
if operator_ui_path.exists():
    app.mount(
        "/operator/ui",
        StaticFiles(directory=str(operator_ui_path), html=True),
        name="operator_ui",
    )
    write_log("tentaculo_link", f"mounted_operator_ui:{operator_ui_path}")
else:
    write_log(
        "tentaculo_link",
        f"WARNING: operator_ui not found:{operator_ui_path}",
        level="WARNING",
    )


# ============ HEALTH & STATUS ============


@app.get("/health")
async def health():
    """Simple health check."""
    return {"status": "ok", "module": "tentaculo_link", "version": "7.0"}


@app.get("/operator")
async def operator_redirect():
    """Redirect /operator to /operator/ui/."""
    return RedirectResponse(url="/operator/ui/", status_code=302)


@app.get("/vx11/status")
async def vx11_status():
    """Aggregate health check for all modules (async parallel)."""
    import datetime

    clients = get_clients()
    health_results = await clients.health_check_all()
    # Defensive: some clients may (incorrectly) return coroutine objects
    # Ensure all module results are resolved to dicts before summarizing.
    for name, val in list(health_results.items()):
        try:
            if asyncio.iscoroutine(val):
                health_results[name] = await val
        except Exception as _exc:
            health_results[name] = {"status": "error", "error": str(_exc)}

    healthy_count = sum(1 for h in health_results.values() if h.get("status") == "ok")
    total_count = len(health_results)

    write_log("tentaculo_link", "vx11_status:aggregated")
