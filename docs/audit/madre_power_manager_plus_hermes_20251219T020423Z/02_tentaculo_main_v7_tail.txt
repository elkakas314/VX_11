    """
    WebSocket endpoint for Operator clients (v7).
    - Sends initial 'control' message to confirm connection.
    - Echoes client messages (if valid JSON) back to sender.
    - Broadcasts to other clients if message is canonical.
    - Graceful disconnect handling.
    """
    await manager.connect(websocket, client_id)
    try:
        # Send initial control message to confirm connection
        control_msg = {
            "channel": "control",
            "type": "connected",
            "client_id": client_id,
        }
        await websocket.send_json(control_msg)
        write_log("tentaculo_link", f"ws_sent_control:{client_id}")

        # Echo loop: accept messages and send back
        while True:
            try:
                data = await websocket.receive_text()
                try:
                    event = json.loads(data)
                    # Echo event back to sender
                    await websocket.send_json(event)
                    write_log(
                        "tentaculo_link",
                        f"ws_echo:{client_id}:type={event.get('type')}",
                    )

                    # Validate and broadcast if canonical
                    validated = await validate_and_filter_event(event)
                    if validated:
                        await manager.broadcast(validated)
                except json.JSONDecodeError:
                    log_event_rejection("malformed", "invalid JSON")
                    # Connection stays open; client can retry
            except RuntimeError:
                # Connection issue; silently close
                break
    except WebSocketDisconnect:
        await manager.disconnect(client_id)
        write_log("tentaculo_link", f"ws_disconnect_normal:{client_id}")


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=8000)
