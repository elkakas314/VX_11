tentaculo_link/main.py:3:This module re-exports the FastAPI `app` defined in `main_v7.py` so that
tentaculo_link/_legacy/inbox/MOVE_PLAN_20251216.md:12:- **Core:** `main_v7.py` (FastAPI app)
tentaculo_link/_legacy/inbox/MOVE_PLAN_20251216.md:29:├── main_v7.py                      # FastAPI app (v7 canonical)
tentaculo_link/_legacy/inbox/MOVE_PLAN_20251216.md:92:   - Added: `@app.post("/events/ingest")` endpoint
tentaculo_link/_legacy/inbox/MOVE_PLAN_20251216.md:146:- [x] **Dependencies:** Minimal (FastAPI + HTTP clients, no heavy IA)
tentaculo_link/_legacy/inbox/MOVE_PLAN_20251216.md:176:- **FastAPI:** HTTP framework (async, low overhead)
tentaculo_link/__init__.py:3:Exports FastAPI app from tentaculo_link.main_v7.
tentaculo_link/main_v7.py:385:**Versión:** 7.0 | **Fase:** G | **Actualizado:** 2025-12-14---- `config/settings.py` — Configuración centralizada- `tentaculo_link/context7_middleware.py` — Context-7 sessions TTL- `tentaculo_link/routes.py` — Route table static- `tentaculo_link/clients.py` — ModuleClient + CircuitBreaker- `tentaculo_link/main_v7.py` — Endpoints principales## Referencias---```    - hermes    - switch    - madre  depends_on:    - vx11  networks:    # ... etc    - SWITCH_PORT=8002    - MADRE_PORT=8001    - ENABLE_AUTH=true    - VX11_TENTACULO_LINK_TOKEN=vx11-local-token    - TENTACULO_LINK_PORT=8000  environment:    - "8000:8000"  ports:  image: vx11/tentaculo_link:latesttentaculo_link:# docker-compose.yml```yaml## Docker Compose---```# context7.add_message(...)# context7 = get_context7_manager()```pythonComentar middleware en `main_v7.py`:### Deshabilitar Context-7```self.circuit_breaker = None  # o usar un mock que siempre retorna should_attempt=True# En ModuleClient.__init__()```pythonModificar `clients.py`:### Deshabilitar Circuit Breaker```ENABLE_AUTH=false# .env```bash### Deshabilitar Autenticación (Solo Dev Local)## Desactivar Características (Opcionales)---3. Si es manual: enviar POST `/vx11/context-7/cleanup` (si existe endpoint)2. Verificar logs de cleanup: `grep "cleanup_expired" logs/`1. Chequear que `CONTEXT7_CLEANUP_INTERVAL` está configurado**Solución:****Causa:** Context-7 no limpian sesiones expiradas o cleanup parado**Síntoma:** Memoria crece constantemente### TTL Sessions Acumuladas```curl -H "X-VX11-Token: vx11-local-token" ...# Incluir en requestsexport VX11_TENTACULO_LINK_TOKEN="vx11-local-token"# Asegurar token en env var```bash**Solución:****Causa:** Header `X-VX11-Token` faltante o incorrecto**Síntoma:** `401 Unauthorized`### Token Inválido4. Si necesita forzar reset: reiniciar Tentáculo Link3. Circuit breaker se auto-recuperará tras `recovery_timeout` (default 60s)2. Ver logs del módulo1. Chequear módulo target: `curl http://127.0.0.1:{puerto}/health`**Solución:**- Errores persistentes en el módulo- Módulo respondiendo lentamente (timeouts)- Módulo no disponible (proceso muerto, puerto cerrado)**Causas:****Síntoma:** Responses con `"status": "circuit_open"`### Circuit Breaker Abierto## Troubleshooting---```  http://127.0.0.1:8000/vx11/context-7/sessionscurl -H "X-VX11-Token: vx11-local-token" \# Ver sesiones activas```bash### Context-7 Sessions```  }'    "metadata": {"source": "ui"}    "session_id": "session-001",    "message": "Hola, ¿cómo estás?",  -d '{  -H "Content-Type: application/json" \  -H "X-VX11-Token: vx11-local-token" \curl -X POST http://127.0.0.1:8000/operator/chat \# Route chat to Switch (via Tentáculo Link)```bash### Chat Routing```  http://127.0.0.1:8000/vx11/circuit-breaker/statuscurl -H "X-VX11-Token: vx11-local-token" \# Circuit breaker status# { "ok": true, "modules": {...}, "summary": {...} }curl http://127.0.0.1:8000/vx11/status# Aggregated status (all modules)# { "status": "ok", "module": "tentaculo_link", "version": "7.0" }curl http://127.0.0.1:8000/health# Simple health```bash### Health Checks## Endpoints Principales---```http://127.0.0.1:8000/openapi.json# OpenAPI JSONhttp://127.0.0.1:8000/redoc# ReDochttp://127.0.0.1:8000/docs# Swagger UI```bashTentáculo Link expone documentación automática:## OpenAPI Docs---```# }#   "total": 1#   ],#     }#       "message_count": 5#       "expires_at": "2025-12-14T11:30:00Z",#       "created_at": "2025-12-14T10:30:00Z",#       "session_id": "session-001",#     {#   "sessions": [# {# Respuesta:  http://127.0.0.1:8000/vx11/context-7/sessions | jq .curl -H "X-VX11-Token: vx11-local-token" \# Ver sesiones activas```bash### Monitorear Sesiones```        # Borra sesiones expiradas (tarea background)    def cleanup_expired(self):            # Retorna resumen de contexto para enviar al LLM    def get_hint_for_llm(self, session_id):            # Agrega mensaje a contexto de sesión    def add_message(self, session_id, role, content):            self.ttl_seconds = ttl_seconds        self.sessions = {}  # session_id → context    def __init__(self, ttl_seconds=3600):class Context7Manager:# Ver context7_middleware.py para detalles```python### ImplementaciónContext-7 es un middleware que mantiene estado de sesión en memoria con TTL auto-cleanup.### ¿Qué es?## Context-7 (TTL Sessions)---```)    timeout=25.0,    method="POST",    endpoint="/my_module/process",    module="my_module",ROUTE_TABLE[IntentType.MY_CUSTOM] = RouteConfig(# En routes.py (recomendado)```python### Agregar Nueva Ruta```print(all_routes.keys())  # dict_keys(['chat', 'code', 'audio', ...])all_routes = list_routes()# Listar todas las rutasprint(route.module, route.endpoint, route.timeout)  # switch, /switch/route-v5, 15.0route = get_route("chat")# Obtener ruta específicafrom tentaculo_link.routes import get_route, list_routes```python### Usoing Route Lookup```}    ...    IntentType.ANALYSIS: RouteConfig(module="madre", endpoint="/madre/task", ...),    IntentType.AUDIO:   RouteConfig(module="hermes", endpoint="/hermes/analyze-audio", ...),    IntentType.CODE:    RouteConfig(module="switch", endpoint="/switch/route-v5", ...),    IntentType.CHAT:    RouteConfig(module="switch", endpoint="/switch/route-v5", ...),ROUTE_TABLE = {# Ejemplos:```pythonEl archivo `routes.py` define mapeo estático `IntentType → RouteConfig`:### Mapeo de Intents## Route Table---```# }#   "timestamp": 1702616420.3#   },#     "switch": { "state": "half_open", "failure_count": 2, "last_failure": 1702616400.5 }#     "madre": { "state": "closed", "failure_count": 0, "last_failure": null },#   "breakers": {#   "status": "ok",# {# Respuesta:  http://127.0.0.1:8000/vx11/circuit-breaker/status | jq .curl -H "X-VX11-Token: vx11-local-token" \# Ver status de todos los circuit breakers```bash### Monitoreo| **HALF_OPEN** | Esperando recuperación | Intenta 1 request de prueba; si éxito → CLOSED; si fallo → OPEN || **OPEN** | Módulo no disponible | Rechaza requests, retorna `circuit_open` || **CLOSED** | Normal | Procesa requests ||--------|-------------|--------|| Estado | Descripción | Acción |### Estados```)    recovery_timeout=60.0,    # Intenta recuperación tras 60s    failure_threshold=3,      # Abre después de 3 fallosself.circuit_breaker = CircuitBreaker(# En clients.py: ModuleClient.__init__()```python### Configuración## Circuit Breaker---```CONTEXT7_TTL_SECONDS=3600OPERATOR_PORT=8011HERMES_PORT=8003SWITCH_PORT=8002MADRE_PORT=8001ENABLE_AUTH=falseVX11_TENTACULO_LINK_TOKEN=vx11-local-tokenTENTACULO_LINK_PORT=8000```bash### `.env` Mínimo (Desarrollo Local)```CONTEXT7_CLEANUP_INTERVAL=300  # limpieza cada 5 minCONTEXT7_TTL_SECONDS=3600  # sesiones expiran en 1 hora# Context-7 TTL# ... etcOPERATOR_URL="http://operator-backend:8011"HERMES_URL="http://hermes:8003"SWITCH_URL="http://switch:8002"MADRE_URL="http://madre:8001"# Módulos (URLs)ENABLE_AUTH=true  # false para dev localVX11_GATEWAY_TOKEN="vx11-local-token"  # fallbackVX11_TENTACULO_LINK_TOKEN="vx11-local-token"# AutenticaciónTENTACULO_LINK_PORT=8000# Puerto```bash### Env Variables## Configuración---```8. Si fallo: registra en circuit breaker, retorna error   ↓7. Si éxito: graba en contexto, retorna respuesta   ↓   - Si HALF_OPEN: intenta recovery   - Si OPEN: retorna circuit_open + fallback   - Si CLOSED: intenta request6. ModuleClient verifica circuit breaker (¿módulo disponible?)   ↓5. Obtiene ModuleClient para módulo target   ↓4. Tentáculo Link consulta route table (routes.py)   ↓3. Context-7 middleware: agrega sesión si es nueva   ↓2. Token validation (X-VX11-Token header)   ↓1. Request entra a Tentáculo Link (:8000)```### Flujo| **Context-7** | `context7_middleware.py` | Gestor de sesiones con TTL auto-cleanup || **Route table** | `routes.py` | Mapeo intento_type → endpoint + módulo || **Module clients** | `clients.py` | HTTP clients para cada módulo con circuit breaker || **Main app** | `main_v7.py` | FastAPI app, endpoints principales ||-----------|---------|---------|| Componente | Archivo | Función |### Componentes## Arquitectura---**Puerto:** 8000 | **Objetivo:** HTTP gateway con autenticación, router inteligente, circuit breaker y TTL Context-7.**Versión:** 7.0 | **Módulo:** `tentaculo_link`  Pure proxy + auth + context-7 middleware + modular clients
tentaculo_link/main_v7.py:398:    FastAPI,
tentaculo_link/main_v7.py:475:async def lifespan(app: FastAPI):
tentaculo_link/main_v7.py:490:app = FastAPI(
tentaculo_link/main_v7.py:509:@app.get("/health")
tentaculo_link/main_v7.py:515:@app.get("/vx11/status")
tentaculo_link/main_v7.py:562:@app.get("/vx11/circuit-breaker/status")
tentaculo_link/main_v7.py:582:@app.post("/operator/chat")
tentaculo_link/main_v7.py:617:@app.get("/operator/session/{session_id}")
tentaculo_link/main_v7.py:644:@app.post("/events/ingest")
tentaculo_link/main_v7.py:720:@app.get("/vx11/overview")
tentaculo_link/main_v7.py:748:@app.get("/shub/dashboard")
tentaculo_link/main_v7.py:760:@app.get("/resources")
tentaculo_link/main_v7.py:778:@app.get("/hormiguero/queen/status")
tentaculo_link/main_v7.py:787:@app.get("/hormiguero/report")
tentaculo_link/main_v7.py:799:@app.get("/operator/snapshot")
tentaculo_link/main_v7.py:818:@app.exception_handler(HTTPException)
tentaculo_link/main_v7.py:1214:@app.get("/debug/events/cardinality")
tentaculo_link/main_v7.py:1232:@app.get("/debug/events/correlations")
tentaculo_link/main_v7.py:1246:@app.websocket("/ws")
tentaculo_link/api/v1_gateway.py:3:This module provides a small APIRouter that delegates to the existing
tentaculo_link/api/v1_gateway.py:7:from fastapi import APIRouter
tentaculo_link/api/v1_gateway.py:10:router = APIRouter()
