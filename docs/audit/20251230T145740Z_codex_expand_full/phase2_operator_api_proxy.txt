    clients = get_clients()
    context7 = get_context7_manager()
    cache = get_cache()
    limiter = get_rate_limiter()
    metrics = get_prometheus_metrics()

    await clients.startup()
    await cache_startup()  # Initialize Redis cache

    # Link Redis to rate limiter
    if cache.redis:
        set_redis_for_limiter(cache.redis)

    FILES_DIR.mkdir(parents=True, exist_ok=True)
    write_log(
        "tentaculo_link", "startup:v7_initialized (with cache+rate_limit+metrics)"
    )

    # Yield to allow app to run
    yield

    # Shutdown
    await clients.shutdown()
    await cache_shutdown()
    write_log("tentaculo_link", "shutdown:v7_complete")


# Create app
app = FastAPI(
    title="VX11 TentÃ¡culo Link",
    version="7.0",
    lifespan=lifespan,
)

# Add CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.middleware("http")
async def operator_api_proxy(request: Request, call_next):
    if request.method == "OPTIONS":
        return await call_next(request)
    if request.url.path.startswith("/operator/api"):
        correlation_id = request.headers.get("X-Correlation-Id") or str(uuid.uuid4())
        if settings.enable_auth:
            token_header_value = request.headers.get(settings.token_header)
            if not token_header_value:
                return JSONResponse(status_code=401, content={"detail": "auth_required"})
            if token_header_value != VX11_TOKEN:
                return JSONResponse(status_code=403, content={"detail": "forbidden"})

        operator_url = settings.operator_url.rstrip("/")
        request_path = request.url.path
        if request_path.startswith("/operator/api/v1"):
            upstream_path = request_path.replace("/operator/api/v1", "/api/v1", 1)
        else:
            upstream_path = request_path.replace("/operator/api", "/api/v1", 1)
        target_url = f"{operator_url}{upstream_path}"
        headers = dict(request.headers)
        headers["X-Correlation-Id"] = correlation_id
        headers[settings.token_header] = headers.get(settings.token_header, VX11_TOKEN)

        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                if request.method == "GET" and request.url.path.endswith(
                    "/events/stream"
                ):
                    async with client.stream(
                        request.method,
                        target_url,
                        headers=headers,
                        params=request.query_params,
                    ) as resp:
                        if resp.status_code >= 400:
                            return JSONResponse(
                                status_code=resp.status_code,
                                content=resp.json(),
                                headers={"X-Correlation-Id": correlation_id},
                            )
                        return StreamingResponse(
                            resp.aiter_raw(),
                            status_code=resp.status_code,
                            media_type=resp.headers.get(
                                "content-type", "text/event-stream"
                            ),
                            headers={"X-Correlation-Id": correlation_id},
                        )

                body = await request.body()
                resp = await client.request(
                    request.method,
                    target_url,
                    headers=headers,
                    params=request.query_params,
                    content=body or None,
