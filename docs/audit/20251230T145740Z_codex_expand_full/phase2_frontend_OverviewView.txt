import { useEffect, useState } from 'react'
import { apiClient } from '../services/api'

interface StatusService {
    name: string
    status: string
    port?: number
    enabled_by_default?: boolean
}

interface StatusResponse {
    data?: {
        system_state?: {
            operational_mode?: string
            policy_active?: string
        }
        services?: StatusService[]
        dormant_services?: { name: string; port?: number; status?: string }[]
    }
}

interface ModuleData {
    name: string
    status: string
    version?: string
    health?: string
}

interface ScoreData {
    order_fs_pct: number
    coherencia_routing_pct: number
    automatizacion_pct: number
    autonomia_pct: number
    global_ponderado_pct: number
}

interface SwitchProviderData {
    status?: string
    selected_provider?: string
    explainability?: { source?: string; note?: string }
    providers?: { name: string; kind: string; status: string }[]
    message?: string
}

interface AuditRunItem {
    run_id: string
    run_ts?: string | null
    status?: string
}

export function OverviewView() {
    const [status, setStatus] = useState<StatusResponse | null>(null)
    const [modules, setModules] = useState<ModuleData[]>([])
    const [scorecard, setScorecard] = useState<ScoreData | null>(null)
    const [switchProvider, setSwitchProvider] = useState<SwitchProviderData | null>(null)
    const [auditRuns, setAuditRuns] = useState<AuditRunItem[]>([])
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState<string | null>(null)

    useEffect(() => {
        loadData()
    }, [])

    async function loadData() {
        setLoading(true)
        setError(null)

        try {
            const [statusResp, modulesResp, scorecardResp, switchResp, auditResp] = await Promise.all([
                apiClient.status(),
                apiClient.modules(),
                apiClient.scorecard(),
                apiClient.switchProvider(),
                apiClient.auditRuns(),
            ])

            if (statusResp.ok && statusResp.data) {
                setStatus(statusResp.data)
            }

            if (modulesResp.ok && modulesResp.data?.modules) {
                const moduleData = modulesResp.data.modules as Record<string, { status?: string }>
                const mods = Object.entries(moduleData).map(([name, info]) => ({
                    name,
                    status: info?.status || 'unknown',
                }))
                setModules(mods)
            }

            if (scorecardResp.ok && scorecardResp.data) {
                const metrics = scorecardResp.data.percentages?.metrics
                if (metrics) {
                    setScorecard({
                        order_fs_pct: metrics.Orden_fs_pct ?? 0,
                        coherencia_routing_pct: metrics.Coherencia_routing_pct ?? 0,
                        automatizacion_pct: metrics.Automatizacion_pct ?? 0,
                        autonomia_pct: metrics.Autonomia_pct ?? 0,
                        global_ponderado_pct: metrics.Global_ponderado_pct ?? 0,
                    })
                }
            }

            if (switchResp.ok && switchResp.data) {
                setSwitchProvider(switchResp.data)
            } else if (switchResp.data) {
                setSwitchProvider(switchResp.data)
            }

            if (auditResp.ok && auditResp.data?.runs) {
                setAuditRuns(auditResp.data.runs as AuditRunItem[])
            }
        } catch (err: any) {
            setError(err.message || 'Failed to load overview')
        } finally {
            setLoading(false)
        }
    }

    if (loading) {
        return <div className="view-loading">⟳ Loading overview...</div>
    }

    const services = status?.data?.services || []
    const coreServices = services.filter((service) =>
        ['madre', 'tentaculo_link', 'redis'].includes(service.name)
    )

    return (
        <div className="overview-view">
            <h2>Ant View</h2>

            {error && <div className="error-banner">⚠️ {error}</div>}

            <div className="widget-grid">
                <div className="widget card">
                    <h3>Core Status</h3>
                    <dl className="status-list">
                        <dt>Policy</dt>
                        <dd>{status?.data?.system_state?.policy_active || '—'}</dd>

                        <dt>Mode</dt>
                        <dd>{status?.data?.system_state?.operational_mode || '—'}</dd>

                        <dt>Core Services</dt>
                        <dd>
                            {coreServices.length > 0
                                ? coreServices.map((service) => `${service.name}:${service.status}`).join(', ')
                                : '—'}
                        </dd>
                    </dl>
                </div>

                <div className="widget card">
                    <h3>Profiles (Dormant)</h3>
                    {status?.data?.dormant_services?.length ? (
                        <ul className="tag-list">
                            {status.data.dormant_services.map((service) => (
                                <li key={service.name}>
                                    {service.name} {service.port ? `:${service.port}` : ''}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="empty">No dormant profiles reported</p>
                    )}
                </div>

                <div className="widget card">
                    <h3>Active Modules</h3>
                    <div className="module-list">
                        {modules.length > 0 ? (
                            modules.map((m) => (
                                <div key={m.name} className="module-item">
                                    <span className="module-name">{m.name}</span>
                                    <span className={`module-status status-${m.status?.toLowerCase() || 'unknown'}`}>
                                        {m.status || '?'}
                                    </span>
                                </div>
                            ))
                        ) : (
                            <p className="empty">No modules available</p>
                        )}
                    </div>
                </div>

                {scorecard && (
                    <div className="widget card">
                        <h3>Performance Metrics</h3>
                        <dl className="scorecard-list">
                            <dt>Order (fs)</dt>
                            <dd>{scorecard.order_fs_pct.toFixed(1)}%</dd>

                            <dt>Routing Coherence</dt>
                            <dd>{scorecard.coherencia_routing_pct.toFixed(1)}%</dd>

                            <dt>Automation</dt>
                            <dd>{scorecard.automatizacion_pct.toFixed(1)}%</dd>

                            <dt>Autonomy</dt>
                            <dd>{scorecard.autonomia_pct.toFixed(1)}%</dd>

                            <dt className="global">Global Score</dt>
                            <dd className="global">
                                <strong>{scorecard.global_ponderado_pct.toFixed(1)}%</strong>
                            </dd>
                        </dl>
                    </div>
                )}

                <div className="widget card">
                    <h3>Switch Provider</h3>
                    {switchProvider?.selected_provider ? (
                        <dl className="status-list">
                            <dt>Selected</dt>
                            <dd>{switchProvider.selected_provider}</dd>

                            <dt>Explainability</dt>
                            <dd>{switchProvider.explainability?.note || '—'}</dd>

                            <dt>Providers</dt>
                            <dd>{switchProvider.providers?.length || 0} total</dd>
                        </dl>
                    ) : (
                        <p className="empty">
                            {switchProvider?.message || 'Switch unavailable (profile not active)'}
                        </p>
                    )}
                </div>

                <div className="widget card">
                    <h3>Recent Audits</h3>
                    {auditRuns.length > 0 ? (
                        <ul className="tag-list">
                            {auditRuns.slice(0, 3).map((run) => (
                                <li key={run.run_id}>
                                    {run.run_id}
                                    {run.run_ts ? ` • ${new Date(run.run_ts).toLocaleString()}` : ''}
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <p className="empty">No audit runs available</p>
                    )}
                </div>
            </div>

            <div className="view-actions">
                <button onClick={loadData} className="btn-secondary">
                    ⟳ Refresh
                </button>
            </div>
        </div>
    )
}
