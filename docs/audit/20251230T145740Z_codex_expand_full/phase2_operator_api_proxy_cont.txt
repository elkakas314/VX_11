                    content=body or None,
                )
        except Exception:
            return JSONResponse(
                status_code=403,
                content={
                    "status": "OFF_BY_POLICY",
                    "service": "operator_backend",
                    "message": "Disabled by SOLO_MADRE policy",
                    "correlation_id": correlation_id,
                    "recommended_action": "Ask Madre to open operator window",
                },
                headers={"X-Correlation-Id": correlation_id},
            )

        content_type = resp.headers.get("content-type", "")
        if "application/json" in content_type:
            try:
                data = resp.json()
                if isinstance(data, dict) and "correlation_id" not in data:
                    data["correlation_id"] = correlation_id
                return JSONResponse(
                    status_code=resp.status_code,
                    content=data,
                    headers={"X-Correlation-Id": correlation_id},
                )
            except Exception:
                pass

        return Response(
            content=resp.content,
            status_code=resp.status_code,
            media_type=resp.headers.get("content-type", "application/json"),
            headers={"X-Correlation-Id": correlation_id},
        )

    return await call_next(request)

# Mount Operator UI static files
operator_ui_candidates = [
    Path(__file__).parent.parent / "operator_ui" / "frontend" / "dist",
    Path(__file__).parent.parent / "operator" / "frontend" / "dist",
]
operator_ui_path = next(
    (candidate for candidate in operator_ui_candidates if candidate.exists()), None
)
if operator_ui_path:
    app.mount(
        "/operator/ui",
        StaticFiles(directory=str(operator_ui_path), html=True),
        name="operator_ui",
    )
    write_log("tentaculo_link", f"mounted_operator_ui:{operator_ui_path}")
else:
    write_log(
        "tentaculo_link",
        f"WARNING: operator_ui not found: {operator_ui_candidates}",
        level="WARNING",
    )

    @app.get("/operator/ui")
    @app.get("/operator/ui/{path:path}")
    async def operator_ui_missing(path: str = ""):
        return Response(
            content="Operator UI build not found. Run frontend build to generate dist.",
            media_type="text/plain",
            status_code=503,
        )

# Include new operator API routes with /operator prefix
try:
    app.include_router(
        api_routes.events.router, prefix="/operator", tags=["operator-api"]
    )
    app.include_router(
        api_routes.settings.router, prefix="/operator", tags=["operator-api"]
    )
    app.include_router(
        api_routes.audit.router, prefix="/operator", tags=["operator-api"]
    )
    app.include_router(
        api_routes.metrics.router, prefix="/operator", tags=["operator-api"]
    )
    app.include_router(
        api_routes.rails.router, prefix="/operator", tags=["operator-api"]
    )
    app.include_router(
        api_routes.window.router, prefix="/operator", tags=["operator-api"]
    )
    write_log("tentaculo_link", "included_operator_api_routers:success")
except Exception as e:
    write_log(
        "tentaculo_link",
        f"WARNING: failed to include operator routers: {e}",
        level="WARNING",
    )

app.include_router(api_routes.internal.router)
app.include_router(api_routes.hormiguero.router)


