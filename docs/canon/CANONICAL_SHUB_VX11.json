{
    "module": {
        "name": "shubniggurath",
        "alias": "shub",
        "role": "audio-engine",
        "description": "Professional audio DSP processing engine with analysis chains, FX presets, and REAPER file export",
        "version": "1.7.1-canon",
        "internal_port": 8007,
        "published_port": null,
        "profile": "audio"
    },
    "canon_version": "1.7.1-canon",
    "canon_references": {
        "full_spec": "docs/canon/VX11_SHUB_CANONICAL_v1.7.1-canon.full.json",
        "flows": "docs/canon/CANONICAL_FLOWS_VX11.json",
        "last_audit": "docs/audit/vx11_shub_integration_20251224T231925Z"
    },
    "security": {
        "public_access": false,
        "note": "Port 8007 NOT published to host. Internal network only (docker-compose networking).",
        "gateway": "tentaculo_link (proxy COMPLETE: all /shub/* routed via tentaculo:8000)",
        "proxy_status": "PHASE2_COMPLETE - Full /shub/{path} proxy implemented",
        "entry_guard": {
            "mode": "strict",
            "required_headers": {
                "X-VX11-Entry": "tentaculo_link",
                "X-VX11-Request-Id": "uuid",
                "X-VX11-Correlation-Id": "uuid",
                "X-VX11-Timestamp": "unix_seconds",
                "X-VX11-Nonce": "unique_identifier",
                "X-VX11-Signature": "HMAC-SHA256"
            },
            "algorithm": "HMAC-SHA256",
            "replay_protection": {
                "enabled": true,
                "table": "shub_request_nonces",
                "nonce_ttl_seconds": 120,
                "max_skew_seconds": 30
            }
        },
        "window_guard": {
            "required_for_mutators": true,
            "token_type": "vx11_window_token",
            "token_transport": "Authorization: Bearer <token>",
            "issuer": "madre",
            "verify_endpoint": "POST /auth/window/verify",
            "scopes": [
                "shub:mutate",
                "shub:jobs:submit",
                "shub:reaper:control",
                "shub:reaper:index:rebuild"
            ],
            "default_scope": "shub:mutate"
        },
        "proxy_details": {
            "route": "@app.api_route('/shub/{path:path}', methods=[GET, POST, PUT, PATCH, DELETE, OPTIONS, HEAD])",
            "upstream": "http://shubniggurath:8007",
            "correlation_id": "X-Correlation-ID (generated if not provided)",
            "auth": "X-VX11-GW-TOKEN for protected endpoints",
            "public_endpoints": [
                "/shub/health",
                "/shub/ready",
                "/shub/openapi.json"
            ],
            "error_503": "Shub unavailable (with correlation_id)",
            "rate_limiting": {
                "phase": "PHASE_3_2_IMPLEMENTED",
                "per_user_limit": 1000,
                "per_user_window_seconds": 60,
                "per_ip_limit": 5000,
                "per_ip_window_seconds": 60,
                "protected_limit": 100,
                "protected_window_seconds": 60,
                "backend": "Redis token bucket",
                "response_on_limit": "429 Too Many Requests with Retry-After header",
                "identifier_user": "X-VX11-GW-TOKEN",
                "identifier_ip": "client remote IP"
            },
            "metrics": {
                "phase": "PHASE_3_3_IMPLEMENTED",
                "endpoint": "/metrics",
                "format": "Prometheus text format",
                "metrics": [
                    "shub_proxy_requests_total{status,path,method}",
                    "shub_proxy_latency_ms{quantile}",
                    "cache_hit_total",
                    "cache_miss_total",
                    "cache_hit_rate",
                    "rate_limit_rejections",
                    "vx11_uptime_seconds"
                ],
                "latency_percentiles": [
                    "p50",
                    "p95",
                    "p99"
                ],
                "scrape_interval": "30s (standard Prometheus)",
                "cache_metrics": "Tracked per proxy request"
            },
            "patterns_documentation": {
                "phase": "PHASE_3_4_IMPLEMENTED",
                "location": "docs/patterns/GATEWAY_PATTERNS.md",
                "patterns": [
                    "Circuit Breaker (5 failures, 60s recovery)",
                    "Retry Backoff (100ms, 250ms, 625ms exponential)",
                    "Backpressure Management (priority queue drop)",
                    "Health Check Tuning (5s -> 1s adaptive)",
                    "Timeout Strategy (2-120s per operation)",
                    "Request Deduplication (X-Idempotency-Key)",
                    "Correlation Tracing (X-Correlation-ID propagation)",
                    "Prometheus Alerting Rules"
                ],
                "all_patterns_reference": "CANONICAL_FLOWS_VX11.json flows"
            }
        },
        "auth_required": "X-VX11-Token header (VX11_GATEWAY_TOKEN)",
        "bypass_mitigation": "No published port 8007 = no direct external access possible"
    },
    "deployment": {
        "activation": "docker compose --profile audio up -d shubniggurath",
        "default_state": "OFF (profile=audio, not in default)",
        "dependencies": [
            "tentaculo_link",
            "madre"
        ],
        "optional_dependencies": [
            "switch",
            "hermes",
            "spawner"
        ]
    },
    "resources": {
        "memory_limit": "512m",
        "cpu_note": "No CPU limit; suitable for low-memory ULTRA_LOW_MEMORY=true mode",
        "reaper_binary": "NOT_INCLUDED (by design; DSP simulation in Python, REAPER file export supported)"
    },
    "endpoints": {
        "health": {
            "path": "/health",
            "method": "GET",
            "description": "Health check; returns service status",
            "access": "via_gateway_or_internal"
        },
        "ready": {
            "path": "/ready",
            "method": "GET",
            "description": "Readiness probe",
            "access": "via_gateway_or_internal"
        },
        "status": {
            "path": "/status",
            "method": "GET",
            "description": "Full service status",
            "access": "via_gateway_or_internal"
        },
        "analyze": {
            "path": "/api/analyze",
            "method": "POST",
            "description": "Audio analysis (DSP, spectrum, loudness, etc)",
            "access": "via_gateway_or_internal"
        },
        "mastering": {
            "path": "/api/mastering",
            "method": "POST",
            "description": "Mastering chain application",
            "access": "via_gateway_or_internal"
        },
        "batch_submit": {
            "path": "/api/batch/submit",
            "method": "POST",
            "description": "Submit batch job (multiple files)",
            "access": "via_gateway_or_internal"
        },
        "batch_status": {
            "path": "/api/batch/status/{job_id}",
            "method": "GET",
            "description": "Get batch job status",
            "access": "via_gateway_or_internal"
        },
        "batch_cancel": {
            "path": "/api/batch/cancel/{job_id}",
            "method": "DELETE",
            "description": "Cancel batch job",
            "access": "via_gateway_or_internal"
        },
        "reaper_projects": {
            "path": "/api/reaper/projects",
            "method": "GET",
            "description": "List REAPER project presets",
            "access": "via_gateway_or_internal"
        },
        "reaper_apply_preset": {
            "path": "/api/reaper/apply-preset",
            "method": "POST",
            "description": "Apply REAPER preset to audio",
            "access": "via_gateway_or_internal"
        },
        "shub_execute": {
            "path": "/shub/execute",
            "method": "POST",
            "description": "Execute Shub-specific task (internal)",
            "access": "internal_only"
        },
        "madre_analyze": {
            "path": "/shub/madre/analyze",
            "method": "POST",
            "description": "Madre orchestration point (analyze via Madre)",
            "access": "via_madre"
        },
        "madre_batch_submit": {
            "path": "/shub/madre/batch/submit",
            "method": "POST",
            "description": "Submit batch via Madre orchestration",
            "access": "via_madre"
        },
        "madre_health_cascade": {
            "path": "/shub/madre/health-cascade",
            "method": "GET",
            "description": "Health cascade to Madre",
            "access": "internal_only"
        },
        "madre_task_status": {
            "path": "/shub/madre/task/{task_id}/status",
            "method": "GET",
            "description": "Get task status (Madre orchestrated)",
            "access": "via_madre"
        }
    },
    "verification_flows": [
        {
            "name": "SHUB_AUDIO_PROFILE_UP_DOWN",
            "description": "Verify Shub starts/stops correctly with audio profile",
            "steps": [
                "docker compose --profile audio up -d shubniggurath",
                "wait 5 seconds for startup",
                "curl http://localhost:8000/health (tentaculo still OK)",
                "docker compose logs shubniggurath | grep -i listening (should show 8007)",
                "docker ps | grep shubniggurath (should NOT show published port 8007)",
                "docker compose exec tentaculo_link curl http://shubniggurath:8007/health (internal OK)",
                "docker compose stop shubniggurath",
                "docker compose ps (shubniggurath should be gone)"
            ],
            "expected_evidence": "clean start/stop; no port bypass"
        },
        {
            "name": "SHUB_NO_PUBLIC_PORT_EXPOSED",
            "description": "Verify port 8007 is NOT published to host",
            "steps": [
                "docker compose --profile audio up -d shubniggurath",
                "docker ps --filter name=shubniggurath (check PORTS column)",
                "ss -lntp | grep 8007 (verify NOT listening on 0.0.0.0)",
                "curl http://localhost:8007/health from host (should timeout or refuse)"
            ],
            "expected_evidence": "port 8007 NOT in PORTS column; curl timeout"
        },
        {
            "name": "SHUB_ENDPOINTS_MATRIX",
            "description": "Verify all real endpoints respond internally",
            "steps": [
                "docker compose --profile audio up -d shubniggurath",
                "curl internal endpoints via tentaculo or direct compose exec",
                "document response codes + latencies"
            ],
            "expected_evidence": "endpoints_matrix.txt with status codes"
        },
        {
            "name": "SHUB_GATEWAY_FALLBACK_READY",
            "description": "Verify Tentaculo can proxy /shub/* (when implemented)",
            "status": "READY (proxy not yet implemented; documented for Phase 2)",
            "expected_step": "curl http://localhost:8000/shub/health -> proxy to internal 8007"
        }
    ],
    "known_gaps": [
        {
            "gap": "Proxy routing",
            "description": "/shub/* not yet proxied through tentaculo_link; only /shub/dashboard exists",
            "severity": "P1",
            "remediation": "Implement proxy middleware in tentaculo_link/main_v7.py"
        },
        {
            "gap": "REAPER binary",
            "description": "No REAPER binary installed; DSP analysis via Python only; preset export via .rpp format",
            "severity": "P2",
            "remediation": "If live REAPER integration needed, build extended image with REAPER_DOWNLOAD_KEY"
        },
        {
            "gap": "Documentation",
            "description": "Design intent (REAPER-first) not clearly aligned with current implementation (DSP-first)",
            "severity": "P3",
            "remediation": "Update docs/ with accurate feature matrix"
        }
    ],
    "audit_timestamp": "2025-12-24T054408Z",
    "audit_evidence_dir": "docs/audit/vx11_shub_local_audit_20251224T054408Z/",
    "status": "SECURITY_FIXED (P0 port exposure remediated)",
    "ready_for_production": true,
    "notes": [
        "Shub is now internal-only (no published port 8007)",
        "Access via tentaculo proxy OR direct internal networking (docker compose exec)",
        "Madre orchestration point remains: /shub/madre/analyze, /shub/madre/batch/submit",
        "Profile audio is opt-in; Shub does not start by default",
        "Audio profile can be used for temporary audio processing tasks without exposing to host"
    ]
}