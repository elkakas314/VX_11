import * as React from "react";
import { useState, useRef, useEffect } from "react";
import { sendChat, fetchSession, sendSwitchFeedback, callDeepseekWeb, callGeminiWeb } from "../services/api";

type TraceInfo = {
  modules?: string[];
  engine?: string;
  route?: any;
  mode?: string;
  channel?: string;
  fallback_used?: string | boolean;
  latency_ms?: number;
};

type Message = {
  id: string;
  role: "user" | "assistant";
  content: string;
  timestamp: string;
  trace?: TraceInfo;
  latency_ms?: number;
  intent?: string;
};

type Session = {
  id: string;
  name: string;
  createdAt: string;
};

type Props = {
  onSend?: (msg: string, mode: string, metadata?: any) => Promise<any>;
  events: any[];
  profile?: {
    name: string;
    channel: "tentacular" | "dsp" | "ot";
    intent: "default" | "analysis" | "deepseek-helper" | "operator";
    mode: string;
    extra?: Record<string, any>;
  };
  activeTab?: string;
  bridgeHealth?: any;
};

export function ChatPanel({ onSend, events, profile, activeTab, bridgeHealth }: Props) {
  const [input, setInput] = useState("");
  const [mode, setMode] = useState("tentacular");
  const [channel, setChannel] = useState<"tentacular" | "dsp" | "ot">("tentacular");
  const [intent, setIntent] = useState<"default" | "analysis" | "deepseek-helper" | "operator">("default");
  const [messages, setMessages] = useState<Message[]>([]);
  const [sending, setSending] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [sessionId, setSessionId] = useState<string>("");
  const [sessions, setSessions] = useState<Session[]>([]);
  const [liveMode, setLiveMode] = useState<boolean>(true);
  const [activeSessionId, setActiveSessionId] = useState<string>("");
  const [outputFormat, setOutputFormat] = useState<"text" | "json" | "steps">("text");
  const [viewMode, setViewMode] = useState<"conversation" | "traces" | "json">("conversation");
  const [lastRawResponse, setLastRawResponse] = useState<any>(null);
  const [bridgeResult, setBridgeResult] = useState<any>(null);
  const [bridgeLoading, setBridgeLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const errorTimeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const madreProfile = channel === "dsp" || activeTab === "shub" ? "shub_engineer" : "core";

  // Initialize session on mount
  useEffect(() => {
    const newSessionId = `session_${Date.now()}`;
    setSessionId(newSessionId);
    setActiveSessionId(newSessionId);

    const saved = localStorage.getItem("chatSessions");
    const prevSessions: Session[] = saved ? JSON.parse(saved) : [];
    setSessions(prevSessions);
  }, []);

  // Save sessions to localStorage
  useEffect(() => {
    if (sessions.length > 0) {
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
    }
  }, [sessions]);

  // Apply profile defaults when profile changes
  useEffect(() => {
    if (!profile) return;
    setChannel(profile.channel);
    setIntent(profile.intent);
    setMode(profile.mode);
  }, [profile]);

  // Auto-scroll
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const formatTime = (isoString: string) => {
    try {
      const date = new Date(isoString);
      return date.toLocaleTimeString("es-ES", {
        hour: "2-digit",
        minute: "2-digit",
      });
    } catch {
      return "";
    }
  };

  const tracePath = (trace?: TraceInfo) => {
    if (!trace?.modules || trace.modules.length === 0) return "switch";
    return trace.modules.join(" ‚Üí ");
  };

  const send = async () => {
    if (!input.trim()) return;

    setSending(true);
    setError(null);

    const userMsg: Message = {
      id: `u-${Date.now()}`,
      role: "user",
      content: input,
      timestamp: new Date().toISOString(),
      intent,
    };
    setMessages((prev) => [...prev, userMsg]);
    const userInput = input;
    setInput("");

    try {
      const metadata = {
        session_id: sessionId,
        mode: channel === "dsp" ? "shub" : mode,
        channel,
        ui: "operator_frontend",
        live: liveMode,
        output_format: outputFormat,
        intent,
        profile: channel === "dsp" || activeTab === "shub" ? "mother_audio" : "mother_system",
        madre_profile: madreProfile,
        // profile se utiliza por Switch/Hermes para elegir orquestaci√≥n (mother_system vs mother_audio)
        ...(profile?.extra || {}),
      };
      const resp = onSend ? await onSend(userInput, mode, metadata) : await sendChat(userInput, mode, metadata);
      setLastRawResponse(resp);

      // Handle structured response (ok=true/false format)
      if (resp && typeof resp === "object") {
        if (resp.ok === false) {
          // Backend returned error but still ok=false
          const errorMsg = resp.error || resp.message || "Unknown error";
          setError(`Backend: ${errorMsg} (trace: ${resp.trace_id || "none"})`);
          const assistantMsg: Message = {
            id: `a-${Date.now()}`,
            role: "assistant",
            content: `‚ùå Error en m√≥dulo ${resp.module || "operator"}: ${errorMsg}`,
            timestamp: new Date().toISOString(),
            trace: resp.trace,
            intent,
          };
          setMessages((prev) => [...prev, assistantMsg]);
        } else if (resp.ok === true || resp.message || resp.response || resp.reply) {
          // Success response
          const responseText = resp.reply || resp.message || resp.response || "No response";
          const route = resp.route || {};
          const trace: TraceInfo | undefined = resp.trace || {
            modules: route.modules,
            engine: route.engine,
            route,
            latency_ms: resp.metrics?.latency_ms,
          };
          if (trace) {
            (trace as any).intent = resp.intent || intent;
          }
          const latencyMs = resp.metrics?.latency_ms || resp.latency_ms || trace?.latency_ms;
          const assistantMsg: Message = {
            id: `a-${Date.now()}`,
            role: "assistant",
            content: responseText,
            timestamp: new Date().toISOString(),
            trace,
            latency_ms: latencyMs,
            intent: resp.intent || intent,
          };
          setMessages((prev) => {
            const updated = prev.map((m) => (m.id === userMsg.id ? { ...m, trace, latency_ms: latencyMs } : m));
            return [...updated, assistantMsg];
          });
          if (resp.session_id) {
            setSessionId(resp.session_id);
          }
        } else if (resp.error) {
          // Legacy error format
          setError(`Error: ${resp.error}`);
        }
      } else if (resp?.response || resp?.message) {
        // Legacy format
        const responseText = resp.response || resp.message || "No response";
        const assistantMsg: Message = {
          id: `a-${Date.now()}`,
          role: "assistant",
          content: responseText,
          timestamp: new Date().toISOString(),
        };
        setMessages((prev) => [...prev, assistantMsg]);
      } else {
        setError("Empty response from server");
      }
    } catch (e: any) {
      const errorMsg = e.message || String(e);
      setError(`‚ö†Ô∏è Network/Client error: ${errorMsg}`);
      // Add error message to chat
      const errorAssistantMsg: Message = {
        id: `a-${Date.now()}`,
        role: "assistant",
        content: `‚ùå Failed to send message: ${errorMsg}. Please try again.`,
        timestamp: new Date().toISOString(),
      };
      setMessages((prev) => [...prev, errorAssistantMsg]);
    } finally {
      setSending(false);
    }

    // Auto-clear error after 8s
    if (errorTimeoutRef.current) {
      clearTimeout(errorTimeoutRef.current);
    }
    errorTimeoutRef.current = setTimeout(() => setError(null), 8000);
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  };

  const createNewSession = () => {
    const newId = `session_${Date.now()}`;
    const newSession: Session = {
      id: newId,
      name: `Sesi√≥n ${new Date().toLocaleTimeString("es-ES")}`,
      createdAt: new Date().toISOString(),
    };
    setSessions((prev) => [newSession, ...prev]);
    setSessionId(newId);
    setActiveSessionId(newId);
    setMessages([]);
  };

  const switchSession = async (id: string) => {
    setActiveSessionId(id);
    setSessionId(id);
    try {
      const sess = await fetchSession(id);
      if ((sess as any)?.message_count >= 0) {
        const mapped: Message[] = (sess as any).messages?.map((m: any, idx: number) => ({
          id: `${m.role}-${idx}-${Date.now()}`,
          role: m.role === "assistant" ? "assistant" : "user",
          content: m.content || "",
          timestamp: m.timestamp || new Date().toISOString(),
        })) || [];
        setMessages(mapped);
      } else {
        setMessages([]);
      }
    } catch (e: any) {
      setMessages([]);
    }
  };

  const triggerBridge = async (provider: "deepseek" | "gemini") => {
    if (!input.trim()) return;
    setBridgeLoading(true);
    setBridgeResult(null);
    try {
      const resp = provider === "deepseek" ? await callDeepseekWeb(input) : await callGeminiWeb(input);
      setBridgeResult(resp);
    } catch (e: any) {
      setBridgeResult({ ok: false, error: e?.message || "Error en puente web" });
    } finally {
      setBridgeLoading(false);
    }
  };

  const lastAssistant = [...messages].reverse().find((m) => m.role === "assistant");
  const traceRows = messages.slice(-30);
  const jsonPayload = viewMode === "json" ? lastRawResponse || lastAssistant || messages[messages.length - 1] : null;

  return (
    <div className="chat-container">
      <div className="chat-sidebar">
        <div className="chat-sidebar-header">
          <h2>üí¨ SESIONES</h2>
          <button onClick={createNewSession} title="Nueva sesi√≥n">
            ‚äï
          </button>
        </div>
        <ul className="chat-sidebar-list">
          {sessions.map((session) => (
            <li
              key={session.id}
              className={`chat-sidebar-item ${activeSessionId === session.id ? "active" : ""}`}
              onClick={() => switchSession(session.id)}
            >
              {session.name}
            </li>
          ))}
        </ul>
        <div className="chat-sidebar-new" onClick={createNewSession}>
          + Nueva sesi√≥n
        </div>
        <div className="chat-sidebar-section">
          <h3 style={{ marginTop: "16px", fontSize: "12px", color: "#7c92b0" }}>Eventos recientes</h3>
          <div style={{ maxHeight: "180px", overflowY: "auto", fontSize: "12px" }}>
            {events.slice(0, 6).map((ev, idx) => (
              <div key={idx} style={{ padding: "6px 4px", borderBottom: "1px solid #1c2d3f" }}>
                <div style={{ color: "#9fb4cc", fontWeight: 600 }}>{ev.type || "event"}</div>
                <div style={{ color: "#d7e3ff" }}>
                  {(ev.data || ev.payload)?.message ||
                    (ev.data || ev.payload)?.intent_type ||
                    (ev.data || ev.payload)?.module ||
                    (ev.data || ev.payload)?.mode ||
                    "‚Äî"}
                </div>
                <div style={{ color: "#8196b5" }}>{ev.timestamp || ""}</div>
              </div>
            ))}
            {events.length === 0 && <div style={{ color: "#75869f" }}>Sin eventos</div>}
          </div>
        </div>
      </div>

      <div className="chat-main">
        <div style={{ padding: "8px 12px", color: "#9fb4cc", fontSize: "12px" }}>
          <strong style={{ color: "#e5e7eb" }}>MADRE:</strong>{" "}
          {madreProfile === "shub_engineer" ? "Ingeniera de audio (Shub)" : "N√∫cleo"}
        </div>
        <div className="chat-toolbar">
          <div className="chip-group">
            {["tentacular", "analitico", "creativo"].map((m) => (
              <button key={m} className={`chip ${mode === m ? "active" : ""}`} onClick={() => setMode(m)}>
                {m === "tentacular" ? "Tentacular" : m === "analitico" ? "Anal√≠tico" : "Creativo"}
              </button>
            ))}
          </div>
          <div className="chip-group">
            {["text", "json", "steps"].map((fmt) => (
              <button key={fmt} className={`chip ${outputFormat === fmt ? "active" : ""}`} onClick={() => setOutputFormat(fmt as any)}>
                {fmt === "text" ? "Texto" : fmt === "json" ? "JSON" : "Pasos"}
              </button>
            ))}
          </div>
          <div className="chip-group">
            {(["tentacular", "dsp", "ot"] as const).map((ch) => (
              <button key={ch} className={`chip ${channel === ch ? "active" : ""}`} onClick={() => setChannel(ch)}>
                {ch === "dsp" ? "Modo Shub" : ch === "ot" ? "OT/IT" : "VX11"}
              </button>
            ))}
          </div>
          <div className="chip-group">
            {[
              { key: "default", label: "Default" },
              { key: "analysis", label: "An√°lisis" },
              { key: "deepseek-helper", label: "DeepSeek Helper" },
              { key: "operator", label: "Operator" },
            ].map((i) => (
              <button key={i.key} className={`chip ${intent === (i.key as any) ? "active" : ""}`} onClick={() => setIntent(i.key as any)}>
                {i.label}
              </button>
            ))}
          </div>
          <div className="chip-group">
            <button className={`chip ${liveMode ? "active" : ""}`} onClick={() => setLiveMode((v) => !v)}>
              {liveMode ? "Live" : "Batch"}
            </button>
          </div>
          <div className="chip-group view-toggle">
            {[
              { key: "conversation", label: "Conversaci√≥n" },
              { key: "traces", label: "Trazas" },
              { key: "json", label: "JSON" },
            ].map((v) => (
              <button key={v.key} className={`chip ${viewMode === v.key ? "active" : ""}`} onClick={() => setViewMode(v.key as any)}>
                {v.label}
              </button>
            ))}
          </div>
          <div className="chip-group" style={{ marginLeft: "auto", color: "#9fb4cc", fontSize: "12px" }}>
            Sesi√≥n: {activeSessionId || sessionId}
          </div>
        </div>

        {channel === "dsp" && (
          <div className="dsp-banner">
            üéõÔ∏è Modo Shub (DSP) activo ‚Äî se env√≠an intents enriquecidos a Switch/Shub.
          </div>
        )}

        {intent === "deepseek-helper" && (
          <div className="bridge-bar">
            <div>
              <strong style={{ color: "#e5e7eb" }}>Puente web:</strong> dispara DeepSeek/Gemini sin pasar por CLI Hub.
              {bridgeHealth && bridgeHealth.ok === false && (
                <div style={{ color: "#fca5a5", fontSize: "12px" }}>
                  Web Bridge desactivado o sin Playwright/Chromium en servidor VX11.
                </div>
              )}
            </div>
            <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
              <button className="chip" disabled={bridgeLoading || !input.trim() || bridgeHealth?.ok === false} onClick={() => triggerBridge("deepseek")}>
                {bridgeLoading ? "Esperando DeepSeek..." : "Enviar a DeepSeek Web"}
              </button>
              <button className="chip" disabled={bridgeLoading || !input.trim() || bridgeHealth?.ok === false} onClick={() => triggerBridge("gemini")}>
                {bridgeLoading ? "Esperando Gemini..." : "Enviar a Gemini Web"}
              </button>
            </div>
          </div>
        )}

        <div className={`chat-views ${viewMode}`}>
          {viewMode === "conversation" && (
            <div className="chat-messages">
              {messages.length === 0 && (
                <div style={{ textAlign: "center", color: "#999", marginTop: "auto", marginBottom: "auto" }}>
                  <p>Inicia una conversaci√≥n...</p>
                </div>
              )}
              {messages.map((msg) => (
                <div key={msg.id} className={`message ${msg.role}`}>
                  <div className="message-avatar">{msg.role === "user" ? "üë§" : "ü§ñ"}</div>
                  <div style={{ flex: 1 }}>
                    <div className="message-meta-row">
                      <span className="pill">{msg.role === "user" ? "Usuario" : "MADRE"}</span>
                      <span className="pill subtle">{formatTime(msg.timestamp)}</span>
                      {(msg.intent || intent) && <span className="pill subtle">Intent: {msg.intent || intent}</span>}
                      {msg.trace?.engine && <span className="pill accent">{msg.trace.engine}</span>}
                      {msg.latency_ms && <span className="pill subtle">{msg.latency_ms} ms</span>}
                    </div>
                    <div className="message-bubble">{msg.content}</div>
                    {msg.role === "assistant" && (
                      <div style={{ display: "flex", gap: "6px", fontSize: "12px", marginTop: "6px" }}>
                        <button
                          className="chip"
                          onClick={() =>
                            sendSwitchFeedback(msg.trace?.engine || "unknown", true, msg.latency_ms || msg.trace?.latency_ms || 0, 0, undefined)
                          }
                          style={{ padding: "4px 8px" }}
                        >
                          üëç √ötil
                        </button>
                        <button
                          className="chip"
                          onClick={() =>
                            sendSwitchFeedback(
                              msg.trace?.engine || "unknown",
                              false,
                              msg.latency_ms || msg.trace?.latency_ms || 0,
                              0,
                              "user_marked_as_not_useful"
                            )
                          }
                          style={{ padding: "4px 8px" }}
                        >
                          üëé No √∫til
                        </button>
                      </div>
                    )}
                    {msg.trace && (
                      <div className="trace-card trace-compact">
                        <div><strong>Ruta:</strong> {tracePath(msg.trace)}</div>
                        <div><strong>Motor:</strong> {msg.trace.engine || "auto"}</div>
                        <div><strong>Intent:</strong> {(msg as any).intent || (msg.trace as any).intent || "default"}</div>
                        <div><strong>Modo/Canal:</strong> {msg.trace.mode || msg.trace.channel || "tentacular"}</div>
                        <div><strong>Latencia:</strong> {msg.latency_ms || msg.trace.latency_ms || "‚Äî"} ms</div>
                        <div><strong>Fallback:</strong> {String(msg.trace.fallback_used ?? "no")}</div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
              {sending && (
                <div className="message assistant">
                  <div className="message-avatar">ü§ñ</div>
                  <div style={{ flex: 1 }}>
                    <div className="message-bubble">
                      <div className="typing-indicator">
                        <div className="typing-dot"></div>
                        <div className="typing-dot"></div>
                        <div className="typing-dot"></div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              <div ref={messagesEndRef} />
            </div>
          )}

          {viewMode === "traces" && (
            <div className="trace-table">
              <div className="trace-table-head">
                <span>Hora</span>
                <span>Rol</span>
                <span>Intent</span>
                <span>Motor</span>
                <span>Latencia</span>
                <span>Fallback</span>
                <span>Texto</span>
              </div>
              {traceRows.length === 0 && <div style={{ color: "#7c92b0", padding: "12px" }}>Sin mensajes a√∫n.</div>}
              {traceRows.map((msg) => (
                <div key={msg.id} className="trace-table-row">
                  <span>{formatTime(msg.timestamp)}</span>
                  <span className={`pill ${msg.role === "assistant" ? "accent" : ""}`} style={{ justifySelf: "flex-start" }}>
                    {msg.role}
                  </span>
                  <span>{msg.intent || intent}</span>
                  <span>{msg.trace?.engine || "‚Äî"}</span>
                  <span>{msg.latency_ms || msg.trace?.latency_ms || "‚Äî"} ms</span>
                  <span>{String(msg.trace?.fallback_used ?? "no")}</span>
                  <span className="muted">{msg.content.slice(0, 80)}</span>
                </div>
              ))}
            </div>
          )}

          {viewMode === "json" && (
            <div className="json-viewer">
              {jsonPayload ? <pre>{JSON.stringify(jsonPayload, null, 2)}</pre> : <div style={{ color: "#7c92b0" }}>Sin respuesta a√∫n.</div>}
            </div>
          )}
        </div>

        {bridgeResult && (
          <div className="bridge-result">
            <div style={{ display: "flex", justifyContent: "space-between" }}>
              <strong style={{ color: "#e5e7eb" }}>
                {bridgeResult.provider || "puente"} ¬∑ {bridgeResult.ok ? "OK" : "Error"}
              </strong>
              <span style={{ color: "#9fb4cc" }}>{bridgeResult.duration_ms ? `${bridgeResult.duration_ms} ms` : ""}</span>
            </div>
            <div style={{ color: bridgeResult.ok ? "#c7dfff" : "#fca5a5", fontSize: "13px", marginTop: "4px" }}>
              {bridgeResult.error === "playwright_unavailable"
                ? "Playwright/Chromium no instalado/activo en servidor VX11."
                : bridgeResult.text || bridgeResult.error || "Sin texto"}
            </div>
          </div>
        )}

        <div className="chat-input-area">
          <div className="chat-input-wrapper">
            <textarea
              className="chat-input"
              placeholder={madreProfile === "shub_engineer" ? "Describe lo que necesitas en mezcla/audio... (Shift+Enter para nueva l√≠nea)" : "Escribe tu mensaje aqu√≠... (Shift+Enter para nueva l√≠nea)"}
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              disabled={sending}
              rows={1}
            />
            <button className="chat-send-button" onClick={send} disabled={sending || !input.trim()}>
              ‚Üí
            </button>
          </div>
        </div>
      </div>
      {error && <div className="toast">{error}</div>}
    </div>
  );
}
