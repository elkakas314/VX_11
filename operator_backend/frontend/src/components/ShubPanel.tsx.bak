import React, { useEffect, useState } from "react";
import { fetchJSON, postIntent, shubControl } from "../services/api";

type Dashboard = {
  status?: string;
  shub_health?: string;
  active_sessions?: number;
  projects?: any[];
  resources?: { cpu_percent?: number; memory_mb?: number };
};

export function ShubPanel() {
  const [dash, setDash] = useState<Dashboard>({});
  const [text, setText] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [info, setInfo] = useState<string | null>(null);
  const [controlInfo, setControlInfo] = useState<string | null>(null);

  const load = async () => {
    try {
      const res = await fetchJSON("/operator/shub/dashboard");
      setDash(res || {});
    } catch (e: any) {
      setError(e?.message || "No se pudo cargar dashboard");
    }
  };

  useEffect(() => {
    load();
    const interval = setInterval(load, 8000);
    return () => clearInterval(interval);
  }, []);

  const sendIntent = async () => {
    if (!text.trim()) return;
    setLoading(true);
    setError(null);
    setInfo(null);
    try {
      const payload = {
        intent_type: "shub",
        data: { message: text },
        metadata: { channel: "dsp", mode: "dsp" },
      };
      const res = await postIntent(payload);
      setInfo(res?.status || "Enviado");
    } catch (e: any) {
      setError(e?.message || "Error enviando intent");
    } finally {
      setLoading(false);
    }
  };

  const triggerControl = async (action: string, target?: string) => {
    setControlInfo(null);
    try {
      const res = await shubControl(action, target);
      if (res?.ok) {
        setControlInfo("Comando ejecutado");
      } else if (res?.error === "not_implemented") {
        setControlInfo("Acción no disponible en Shub actual");
      } else {
        setControlInfo(res?.error || "Shub no responde");
      }
    } catch (e: any) {
      setControlInfo(e?.message || "Error");
    }
  };

  return (
    <div className="card">
      <div className="card-header">
        <h2>Shub Dashboard</h2>
      </div>
      <div style={{ fontSize: "12px", marginBottom: "8px" }}>
        <div>Estado: {dash.status || "n/a"}</div>
        <div>Salud: {dash.shub_health || "n/a"}</div>
        <div>Sesiones activas: {dash.active_sessions ?? "?"}</div>
        <div>Proyectos: {dash.projects ? dash.projects.length : 0}</div>
        <div>CPU: {dash.resources?.cpu_percent ?? "?"}% · MEM: {dash.resources?.memory_mb ?? "?"} MB</div>
      </div>
      <div style={{ marginBottom: "10px" }}>
        <h4 style={{ fontSize: "12px" }}>Procesar texto (DSP)</h4>
        <textarea
          value={text}
          onChange={(e) => setText(e.target.value)}
          rows={3}
          style={{ width: "100%", padding: "6px", borderRadius: "6px", border: "1px solid #2c3f55", background: "#0f1722", color: "#e3ecf5" }}
          placeholder="Describe mezcla/mastering a analizar..."
        />
        <button className="chip" onClick={sendIntent} disabled={loading || !text.trim()} style={{ marginTop: "6px" }}>
          {loading ? "Enviando..." : "Analizar mezcla"}
        </button>
        {error && <div style={{ color: "#ef4444", fontSize: "11px" }}>{error}</div>}
        {info && <div style={{ color: "#22c55e", fontSize: "11px" }}>{info}</div>}
      </div>
      <div style={{ borderTop: "1px solid #1f2a3a", paddingTop: "8px", marginTop: "8px" }}>
        <h4 style={{ fontSize: "12px" }}>Controles rápidos</h4>
        <div style={{ fontSize: "11px", color: "#9fb4cc", marginBottom: "6px" }}>Control simulado (stub) hasta conectar con Shub real.</div>
        <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
          <button className="chip" onClick={() => triggerControl("favorite_mix")}>Marcar mezcla como favorita</button>
          <button className="chip" onClick={() => triggerControl("toggle_mute", "bus_master")}>Toggle Mute Master</button>
          <button className="chip" onClick={() => triggerControl("reset_dsp_state")}>Reset Estado DSP</button>
        </div>
        {controlInfo && <div style={{ fontSize: "11px", color: controlInfo === "OK" ? "#22c55e" : "#ef4444", marginTop: "6px" }}>{controlInfo}</div>}
      </div>
    </div>
  );
}
