import * as React from "react";

type Props = {
  status: any;
};

const ORDER = ["tentaculo_link", "madre", "switch", "hermes", "hormiguero", "manifestator", "mcp", "shub", "spawner"];
const NAMES: Record<string, string> = {
  tentaculo_link: "Tent√°culo Link",
  madre: "Madre",
  switch: "Switch",
  hermes: "Hermes",
  hormiguero: "Hormiguero",
  manifestator: "Manifestator",
  mcp: "MCP",
  shub: "Shub",
  spawner: "Spawner",
};

const STATUS_COLOR: Record<string, string> = {
  ok: "#22c55e",
  down: "#ef4444",
  standby: "#f59e0b",
  disabled: "#6b7280",
  unknown: "#1f2937",
};

function deriveModules(status: any) {
  if (status?.modules_list?.length) return status.modules_list;
  const modules = status?.modules || {};
  return ORDER.map((key) => {
    const mod = modules[key] || {};
    const normalizedStatus = (mod.status || (mod.ok ? "ok" : "unknown")).toLowerCase();
    const statusValue = normalizedStatus === "healthy" ? "ok" : normalizedStatus;
    return {
      name: key,
      status: statusValue,
      port: mod.port,
      queue_depth: mod.queue_depth,
      incidents_open: mod.incidents_open,
      latency_ms: mod.latency_ms,
      mode: mod.mode,
      last_heartbeat: mod.timestamp || mod.checked_at,
    };
  });
}

export function MiniMapPanel({ status }: Props) {
  const modules = React.useMemo(() => deriveModules(status), [status]);
  const okCount = modules.filter((m: any) => m.status === "ok").length;

  const renderIcon = (mod: any) => {
    if (mod.name === "hormiguero" && (mod.incidents_open || 0) > 0) return "üêú";
    if (mod.name === "switch" && (mod.queue_depth || 0) > 3) return "‚ö°";
    if (mod.name === "shub") return "üéõÔ∏è";
    return "‚¨¢";
  };

  return (
    <div className="card">
      <div className="card-header" style={{ alignItems: "flex-start" }}>
        <div>
          <div style={{ fontSize: "13px", color: "#9fb4cc" }}>Mini Mapa VX11</div>
          <div style={{ fontWeight: 700 }}>Topolog√≠a tentacular</div>
        </div>
        <div style={{ fontSize: "12px", color: "#9fb4cc" }}>
          Salud: {okCount}/{modules.length}
        </div>
      </div>
      <div className="mini-map-grid">
        {modules.map((mod: any) => {
          const statusKey = (mod.status || "unknown").toLowerCase();
          const color = STATUS_COLOR[statusKey] || STATUS_COLOR.unknown;
          const tooltip = [
            `Estado: ${statusKey}`,
            `Latencia: ${mod.latency_ms ?? "‚Äî"}ms`,
            `Cola: ${mod.queue_depth ?? 0}`,
            `Incidentes: ${mod.incidents_open ?? 0}`,
            `Modo: ${mod.mode ?? "?"}`,
            `Heartbeat: ${mod.last_heartbeat ?? "n/d"}`,
          ].join(" | ");
          return (
            <div key={mod.name} className="mini-map-cell" style={{ borderColor: color }} title={tooltip}>
              <div className="mini-map-badge" style={{ color }}>
                {renderIcon(mod)}
              </div>
              <div className="name" style={{ color }}>{NAMES[mod.name] || mod.name}</div>
              <div className="meta">Puerto: {mod.port || "n/a"}</div>
              <div className="meta" style={{ color }}>
                {statusKey === "ok" ? "UP" : statusKey.toUpperCase()} ¬∑ cola {mod.queue_depth ?? 0}
              </div>
              <div style={{ height: "4px", borderRadius: "999px", background: "#0b1322", overflow: "hidden" }}>
                <div style={{ width: mod.latency_ms ? `${Math.min(100, mod.latency_ms / 5)}%` : "20%", height: "100%", background: color, opacity: 0.8 }} />
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
