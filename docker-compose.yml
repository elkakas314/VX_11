services:
  # ========== TENTACULO LINK (PORT 8000) ==========
  tentaculo_link:
    profiles: ["core"]
    build:
      context: .
      dockerfile: tentaculo_link/Dockerfile
      args:
        - REQUIREMENTS_FILE=requirements_tentaculo.txt
    image: vx11-tentaculo-link:v6.7
    container_name: vx11-tentaculo-link
    hostname: tentaculo-link
    networks:
      default:
        aliases:
          - tentaculo_link
    ports:
      - "8000:8000"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./data/backups:/app/data/backups
      - ./build/artifacts/sandbox:/app/sandbox
      - ./models:/app/models
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
      - VX11_REDIS_URL=redis://:vx11-redis-local@redis:6379/0
      - VX11_CACHE_TTL_HEALTH=60
      - VX11_CACHE_ENABLED=true
      - VX11_RATE_LIMIT_ENABLED=true
      - VX11_RATE_LIMIT_USER=1000
      - VX11_RATE_LIMIT_PROTECTED=100
      - VX11_METRICS_ENABLED=true
      - VX11_METRICS_PORT=9090
    mem_limit: 512m
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== MADRE (PORT 8001) ==========
  madre:
    build:
      context: .
      dockerfile: madre/Dockerfile
    image: vx11-madre:v6.7
    container_name: vx11-madre
    ports:
      - "8001:8001"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./build/artifacts/sandbox:/app/sandbox
      - ./models:/app/models
      - /var/run/docker.sock:/var/run/docker.sock:rw
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
      - VX11_ALLOW_SERVICE_CONTROL=1
      - VX11_MAINTENANCE_WINDOW_ENABLED=1
    mem_limit: 512m
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== SWITCH (PORT 8002) ==========
  switch:
    profiles: ["core"]
    build:
      context: .
      dockerfile: switch/Dockerfile
    image: vx11-switch:v6.7
    container_name: vx11-switch
    ports:
      - "8002:8002"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./models:/app/models
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== HERMES (PORT 8003) ==========
  hermes:
    profiles: ["core"]
    image: vx11-hermes:v6.7
    container_name: vx11-hermes
    ports:
      - "8003:8003"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./models:/app/models
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== HORMIGUERO (PORT 8004) ==========
  hormiguero:
    profiles: ["core"]
    image: vx11-hormiguero:v6.7
    container_name: vx11-hormiguero
    ports:
      - "8004:8004"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
      - HORMIGUERO_TENTACULO_URL=http://tentaculo_link:8000
      - HORMIGUERO_MADRE_URL=http://madre:8001
      - HORMIGUERO_SWITCH_URL=http://switch:8002
      - HORMIGUERO_SPAWNER_URL=http://spawner:8008
      - HORMIGUERO_MANIFESTATOR_URL=http://manifestator:8005
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== MANIFESTATOR (PORT 8005) ==========
  manifestator:
    build:
      context: .
      dockerfile: manifestator/Dockerfile
    image: vx11-manifestator:v6.7
    container_name: vx11-manifestator
    profiles: ["disabled", "maintenance"]
    ports:
      - "8005:8005"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - .:/app/vx11:ro # Read-only access to repo
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== MCP (PORT 8006) ==========
  mcp:
    profiles: ["core"]
    build:
      context: .
      dockerfile: mcp/Dockerfile
    image: vx11-mcp:v6.7
    container_name: vx11-mcp
    ports:
      - "8006:8006"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== SHUB NIGGURATH (PORT 8007) ==========
  shubniggurath:
    profiles: ["audio"]
    image: vx11-shub:v6.7
    container_name: vx11-shubniggurath
    # PORT 8007 REMOVED: No direct public access. Access only via tentaculo_link proxy.
    # Internal container port remains 8007 for compose networking.
    # Security: Shub is behind tentaculo gateway when started with --profile audio
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./models:/app/models
      - ./build/artifacts/sandbox:/app/sandbox
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "true"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== SPAWNER (PORT 8008) ==========
  spawner:
    profiles: ["core"]
    build:
      context: .
      dockerfile: spawner/Dockerfile
    image: vx11-spawner:v6.7
    container_name: vx11-spawner
    ports:
      - "8008:8008"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data/runtime:/app/data/runtime
      - ./build/artifacts/sandbox:/app/sandbox
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    mem_limit: 512m
    depends_on:
      - tentaculo_link
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ========== OPERATOR BACKEND (PORT 8011) ==========
  operator-backend:
    profiles: ["operator"]
    build:
      context: .
      dockerfile: operator_backend/backend/Dockerfile
    image: vx11-operator-backend:v7.0
    container_name: vx11-operator-backend
    ports:
      - "8011:8011"
    volumes:
      - ./build/artifacts/logs:/app/logs
      - ./data:/app/data
      - ./models:/app/models
    environment:
      - ULTRA_LOW_MEMORY=true
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
      - VX11_MODE=${VX11_MODE:-operative_core}
      - OPERATOR_ADMIN_PASSWORD=${OPERATOR_ADMIN_PASSWORD:-admin}
      - OPERATOR_TOKEN_SECRET=${OPERATOR_TOKEN_SECRET:-operator-secret-v7}
    mem_limit: 512m
    depends_on:
      - tentaculo_link
      - switch
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ========== OPERATOR FRONTEND (PORT 8020) ==========
  operator-frontend:
    profiles: ["operator"]
    build:
      context: operator_backend/frontend
      dockerfile: Dockerfile
    container_name: vx11-operator-frontend
    ports:
      - "8020:8020"
    depends_on:
      - operator-backend
    restart: unless-stopped
    environment:
      - API_TOKEN=vx11-local-token
      - VX11_GATEWAY_TOKEN=vx11-local-token
      - VX11_TENTACULO_LINK_TOKEN=vx11-local-token
      - VX11_OPERATOR_TOKEN=vx11-local-token
      - VX11_LOCAL_TOKEN=vx11-local-token
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8020"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ========== REDIS (CACHE LAYER - PORT 6379 INTERNAL) ==========
  redis:
    image: redis:7-alpine
    container_name: vx11-redis
    hostname: redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    environment:
      - REDIS_PASSWORD=vx11-redis-local
    command: redis-server --appendonly yes --requirepass vx11-redis-local
    mem_limit: 256m
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "vx11-redis-local", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      default:
        aliases:
          - redis

volumes:
  logs:
    driver: local
  data:
    driver: local
  models:
    driver: local
  sandbox:
    driver: local

networks:
  default:
    name: vx11-network
    driver: bridge
