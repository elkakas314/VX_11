name: VX11 Repository Hygiene

on:
    push:
        branches:
            - main
            - dev
    schedule:
        # Run daily at 2 AM UTC
        - cron: "0 2 * * *"

permissions:
    contents: read
    actions: write

env:
    REGISTRY: ghcr.io
    ARTIFACT_RETENTION: 7 # days

jobs:
    check-secrets:
        runs-on: ubuntu-latest
        name: Secret Scanning
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Scan for secrets (tokens, passwords, keys)
              run: |
                  echo "Scanning for hardcoded secrets..."

                  # Check for common patterns
                  PATTERNS=(
                    "password\s*[:=]\s*['\"]"
                    "token\s*[:=]\s*['\"]"
                    "api_key\s*[:=]\s*['\"]"
                    "secret\s*[:=]\s*['\"]"
                    "private_key"
                    "BEGIN.*PRIVATE.*KEY"
                    "aws_access_key_id"
                    "OPENAI_API_KEY"
                  )

                  FOUND=0
                  for pattern in "${PATTERNS[@]}"; do
                    COUNT=$(grep -r "$pattern" --include="*.py" --include="*.js" --include="*.ts" \
                      --include="*.json" --include="*.yml" --include="*.yaml" \
                      --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=__pycache__ \
                      . 2>/dev/null | grep -v "test\|spec\|example\|fixture" | wc -l)
                    
                    if [ "$COUNT" -gt 0 ]; then
                      echo "‚ö†Ô∏è  Found $COUNT potential secrets matching: $pattern"
                      grep -r "$pattern" --include="*.py" --include="*.js" \
                        --include="*.ts" --include="*.json" --exclude-dir=.git \
                        . 2>/dev/null | head -5
                      FOUND=$((FOUND + COUNT))
                    fi
                  done

                  if [ "$FOUND" -gt 0 ]; then
                    echo "‚ùå Secret scan FAILED: $FOUND potential secrets found"
                    exit 1
                  else
                    echo "‚úì No hardcoded secrets detected"
                  fi

    check-syntax:
        runs-on: ubuntu-latest
        name: Code Syntax Check
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Check Python syntax
              run: |
                  echo "Checking Python syntax..."
                  find . -name "*.py" -type f \
                    -not -path "./.git/*" \
                    -not -path "./node_modules/*" \
                    -not -path "./__pycache__/*" \
                    | head -50 \
                    | xargs -I {} python3 -m py_compile {}
                  echo "‚úì Python syntax OK"

    check-deps:
        runs-on: ubuntu-latest
        name: Dependency Check
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check for outdated Python packages
              run: |
                  echo "Checking for vulnerable Python packages..."
                  pip install safety 2>/dev/null || true

                  if [ -f "requirements.txt" ]; then
                    safety check -r requirements.txt --json > /tmp/safety.json 2>/dev/null || true
                    if [ -s /tmp/safety.json ]; then
                      echo "‚ö†Ô∏è  Vulnerabilities found:"
                      cat /tmp/safety.json | jq .
                    else
                      echo "‚úì No known vulnerabilities"
                    fi
                  fi

    check-audit-rotation:
        runs-on: ubuntu-latest
        name: Audit Rotation Policy
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Verify audit rotation script exists
              run: |
                  if [ -f "scripts/vx11_rotate_audits.sh" ]; then
                    echo "‚úì Audit rotation script found"
                    bash scripts/vx11_rotate_audits.sh --dry-run 2>&1 | tail -5
                  else
                    echo "‚ùå Audit rotation script NOT found"
                    exit 1
                  fi

            - name: Check docs/audit size
              run: |
                  AUDIT_SIZE=$(du -sh docs/audit 2>/dev/null | cut -f1)
                  echo "docs/audit size: $AUDIT_SIZE"

                  # Count OUTDIR directories
                  OUTDIR_COUNT=$(find docs/audit -type d -name "*Z" -o -name "*Z_*" 2>/dev/null | wc -l)
                  echo "OUTDIR directories: $OUTDIR_COUNT"

                  if [ "$OUTDIR_COUNT" -gt 50 ]; then
                    echo "‚ö†Ô∏è  WARNING: More than 50 OUTDIR directories (rotation may be needed)"
                  fi

    check-git-state:
        runs-on: ubuntu-latest
        name: Git State Check
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Check for uncommitted secrets in history
              run: |
                  echo "Checking git history for potential secrets..."

                  # Check for leaked tokens in commits
                  LEAKED=$(git log -p --all -S "token=" --format="%h %s" 2>/dev/null | head -20)

                  if [ -z "$LEAKED" ]; then
                    echo "‚úì No token= patterns in recent history"
                  else
                    echo "‚ö†Ô∏è  Found potential token patterns in history:"
                    echo "$LEAKED" | head -3
                  fi

            - name: Check for large files
              run: |
                  echo "Checking for large files in repo..."

                  LARGE_FILES=$(git ls-files -z | xargs -0 du -h | sort -rh | head -10 | awk '$1 ~ /M|G/')

                  if [ -z "$LARGE_FILES" ]; then
                    echo "‚úì No unusually large files"
                  else
                    echo "‚ö†Ô∏è  Large files detected:"
                    echo "$LARGE_FILES"
                  fi

    generate-scorecard:
        runs-on: ubuntu-latest
        name: Generate SCORECARD
        needs:
            [
                check-secrets,
                check-syntax,
                check-deps,
                check-audit-rotation,
                check-git-state,
            ]
        if: always()
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Generate SCORECARD.json
              run: |
                  mkdir -p docs/audit

                  cat > /tmp/scorecard.json << 'EOF'
                  {
                    "timestamp": "$(date -Iseconds)",
                    "checks": {
                      "secrets": "${{ needs.check-secrets.result }}",
                      "syntax": "${{ needs.check-syntax.result }}",
                      "dependencies": "${{ needs.check-deps.result }}",
                      "audit_rotation": "${{ needs.check-audit-rotation.result }}",
                      "git_state": "${{ needs.check-git-state.result }}"
                    },
                    "overall": "${{ needs.check-secrets.result }}",
                    "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                  EOF

                  cat /tmp/scorecard.json | jq . > docs/audit/SCORECARD_CI.json
                  echo "‚úì SCORECARD generated"

            - name: Upload SCORECARD artifact
              uses: actions/upload-artifact@v4
              with:
                  name: scorecard
                  path: docs/audit/SCORECARD_CI.json
                  retention-days: 14

    cleanup-artifacts:
        runs-on: ubuntu-latest
        name: Cleanup Old Artifacts
        steps:
            - name: Delete artifacts older than retention period
              uses: geekyeggo/delete-artifact@v2
              with:
                  name: |
                      smoke-test-logs
                      scorecard
                  minCreatedTime: ${{ env.ARTIFACT_RETENTION }}d

    result:
        runs-on: ubuntu-latest
        name: Hygiene Report
        needs:
            [
                check-secrets,
                check-syntax,
                check-deps,
                check-audit-rotation,
                check-git-state,
                generate-scorecard,
            ]
        if: always()
        steps:
            - name: Generate hygiene report
              run: |
                  echo "üîç VX11 Repository Hygiene Report"
                  echo "================================"
                  echo ""
                  echo "‚úì Secrets:          ${{ needs.check-secrets.result }}"
                  echo "‚úì Syntax:           ${{ needs.check-syntax.result }}"
                  echo "‚úì Dependencies:     ${{ needs.check-deps.result }}"
                  echo "‚úì Audit Rotation:   ${{ needs.check-audit-rotation.result }}"
                  echo "‚úì Git State:        ${{ needs.check-git-state.result }}"
                  echo "‚úì SCORECARD:        ${{ needs.generate-scorecard.result }}"
                  echo ""

                  if [ "${{ needs.check-secrets.result }}" != "success" ]; then
                    echo "‚ùå Hygiene check FAILED"
                    exit 1
                  else
                    echo "‚úÖ All hygiene checks passed"
                  fi
