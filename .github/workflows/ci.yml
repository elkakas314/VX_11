name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths-ignore:
      - 'docs/**'
      - 'logs/**'
      - '.copilot-audit/**'
      - '*.md'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - 'docs/**'
      - 'logs/**'
      - '.copilot-audit/**'
      - '*.md'

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install pylint black
      - run: black --check tentaculo_link operator_backend 2>/dev/null || true
      - run: pylint tentaculo_link --disable=all --enable=E,F 2>/dev/null || true

  py_compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python -m compileall tentaculo_link operator_backend
        continue-on-error: false

  compose_validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose config > /dev/null
            echo "✓ docker-compose.yml is valid"
          else
            echo "⚠️ docker-compose not available, skipping validation"
          fi
        continue-on-error: true

  frontend_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'operator_backend/frontend/package-lock.json'
      - run: cd operator_backend/frontend && npm ci
      - run: cd operator_backend/frontend && npm run type-check 2>/dev/null || echo "⚠️ No type-check script"
      - run: cd operator_backend/frontend && npm run build
        continue-on-error: true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest pytest-asyncio
      - run: pytest tests/ -v --tb=short

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, py_compile, frontend_build]
    steps:
      - uses: actions/checkout@v4
      - run: echo "✓ All validations passed"
name: CI




















































































































































































































































































































































**Versión:** 1.0 | **Fase:** 0 | **Actualizado:** 2025-12-14---- [config/tokens.py](../config/tokens.py) — Gestión de tokens- [config/settings.py](../config/settings.py) — URLs locales- [docs/API_OPERATOR_CHAT.md](API_OPERATOR_CHAT.md) — Contrato `/operator/chat`- [docs/DEPLOYMENT_TENTACULO_LINK.md](DEPLOYMENT_TENTACULO_LINK.md) — Config Tentáculo Link- [docs/ARCHITECTURE.md](ARCHITECTURE.md) — Diagrama de flujos## Referencias---```  -H "X-VX11-Token: vx11-local-token" | jq . 2>/dev/null || echo "No pheromone data"curl -s http://127.0.0.1:8000/vx11/pheromone-log \# Eventos de feromona (Hormiguero, si está activo)ls -lah forensic/crashes/ 2>/dev/null || echo "No forensic crashes"# Logs generales (forensic)tail -f logs/madre.log 2>/dev/null || echo "No logs"# Logs de Madretail -f logs/tentaculo_link.log 2>/dev/null || echo "No logs"# Logs del Gateway```bash## Debugging: Ver Logs---```# - Backend: Redis cache o archivo local en data/# - Frontend: localStorage o IndexedDB# Si repites la misma query, guarda el resultado localmente:```bash### 3. Cache Results```  }' | jq -r '.task_id'    }      ]        {"file": "b.py", "action": "lint"}        {"file": "a.py", "action": "lint"},      "tasks": [    "payload": {    "intent": "batch_analysis",  -d '{  -H "Content-Type: application/json" \  -H "X-VX11-Token: vx11-local-token" \curl -X POST http://127.0.0.1:8001/madre/task \# Si tienes múltiples queries, agrúpalas en una sola tarea:```bash### 2. Batch Requests (Pseudocódigo)```# Preferir tareas con "provider": "local"# Si Switch retorna "provider": "cli", el token presupuesto se agota rápido.  -H "X-VX11-Token: vx11-local-token" | jq .curl -s http://127.0.0.1:8002/switch/models \# Consultar modelos disponibles```bash### 1. Usar Modelos Locales Siempre que Posible## Optimizaciones Prácticas---```  -H "X-VX11-Token: vx11-local-token" | jq .curl -s http://127.0.0.1:8002/switch/quota \# Chequear quota de tokens antes de enviar:# Fallback: reducir profundidad/complejidad o usar modelos más rápidos# Si una tarea tarda >60s (default), Madre la cancela```bash### Task Timeout```# Solución: verifica tokens.env o variables de entorno# Respuesta: 401 Unauthorized  -d '{"message":"hola"}'  -H "Content-Type: application/json" \  -H "X-VX11-Token: invalid-token" \curl -X POST http://127.0.0.1:8011/operator/chat \# El token X-VX11-Token no es válido```bash### Token Invalid (401)```curl -s http://127.0.0.1:8011/operator/health || echo "❌ Operator backend down"# Fallback: contactar directamente a módulocurl -s http://127.0.0.1:8000/health || echo "❌ Gateway down"# Si 127.0.0.1:8000 no responde```bash### Gateway Unavailable## Error Handling---```  -F "task=transcribe" | jq .  -F "file=@audio.wav" \  -H "X-VX11-Token: vx11-local-token" \curl -X POST http://127.0.0.1:8003/hermes/analyze-audio \# Enviar audio para análisis```bashProcesa audio/streams sin modelo IA pesado.## Pattern: Hermes (Opcional, si existe)---```# Si un circuit está "open", evita llamadas a ese módulo (timeout/fallback automático)# }#   }#     "operator-backend": { "state": "half-open", "failures": 3, "last_failure": "2025-12-14T10:25:00Z" }#     "madre": { "state": "closed", "failures": 0, "last_failure": null },#     "switch": { "state": "closed", "failures": 0, "last_failure": null },#   "breakers": {# {# Respuesta esperada:  -H "X-VX11-Token: vx11-local-token" | jq .curl -s http://127.0.0.1:8000/vx11/circuit-breaker/status \# Ver estado del circuit breaker por módulo```bashEl Tentáculo Link usa circuit breaker para evitar cascadas de fallos. Si un módulo falla repetidamente, el circuit se abre.## Pattern: Monitorear Circuit Breaker---```# }#   "total": 1#   ],#     }#       "expires_at": "2025-12-14T11:30:00Z"#       "ttl_seconds": 3600,#       "last_activity": "2025-12-14T10:31:45Z",#       "created_at": "2025-12-14T10:30:00Z",#       "session_id": "session-001",#     {#   "sessions": [# {# Respuesta:  -H "X-VX11-Token: vx11-local-token" | jq .curl -s http://127.0.0.1:8000/vx11/context-7/sessions \# Ver sesiones activas```bashEl Tentáculo Link mantiene sesiones con TTL. Cuando el TTL expira, la sesión se limpia automáticamente.## Pattern: Context-7 Sesiones TTL---```# }#   "elapsed_ms": 3200#   "error": null,#   },#     "findings": [...]#     "summary": "...",#   "result": {#   "status": "completed",#   "task_id": "...",# {# Estructura esperada:  -H "X-VX11-Token: vx11-local-token" | jq .curl -s http://127.0.0.1:8001/madre/task/$TASK_ID \```bash### 3. Obtener Resultado```fi  echo "⚠️ Task $TASK_ID timed out after ${MAX_WAIT}s"if [ $ELAPSED -ge $MAX_WAIT ]; then# Si timeoutdone  esac      ;;      ELAPSED=$((ELAPSED + 2))      sleep 2    *)      ;;      break    completed|failed)  case $STATUS in    echo "Status: $STATUS (elapsed: ${ELAPSED}s)"      -H "X-VX11-Token: vx11-local-token" | jq -r '.status')  STATUS=$(curl -s http://127.0.0.1:8001/madre/task/$TASK_ID \while [ $ELAPSED -lt $MAX_WAIT ]; doELAPSED=0MAX_WAIT=60# Polling cada 2s hasta completed/failed```bash### 2. Polling Status```echo "Task created: $TASK_ID"  }' 2>/dev/null | jq -r '.task_id')    }      "depth": 3      "file_path": "operator_backend/backend/main_v7.py",    "payload": {    "priority": 5,    "intent": "analyze_code_structure",  -d '{  -H "Content-Type: application/json" \  -H "X-VX11-Token: vx11-local-token" \TASK_ID=$(curl -X POST http://127.0.0.1:8001/madre/task \```bash### 1. Crear Tarea**Caso:** Análisis profundo, refactoring de código, o procesamiento que tardará >5s.## Pattern: Crear Tarea Larga (Madre/Spawner)---```# }#   "latency_ms": 250#   "tokens_used": 120,#   "response": "...",#   "provider": "local",#   "model": "local_deepseek",# {# Respuesta esperada:  }' | jq .    "max_tokens": 500    "task_type": "code",    "prompt": "Analiza esta imagen de código",  -d '{  -H "Content-Type: application/json" \  -H "X-VX11-Token: vx11-local-token" \curl -X POST http://127.0.0.1:8002/switch/route-v5 \# Consultar Switch sin delegación```bashEl Switch elige qué modelo usar basado en task_type, token budget y latencia histórica.## Pattern: Consultar Switch (Routing IA)---7. Registra en BD + retorna reply6. Espera respuesta (timeout 15s)5. Switch elige modelo (local > remote, según token budget)4. Delega a Switch (POST /switch/route-v5) con task_type="chat"3. Crea sesión en BD local (si no existe)2. Valida token X-VX11-Token1. Operator backend recibe POST /operator/chat**Flujo interno:**```# }#   }#     "tokens_used": 42#     "reasoning_time_ms": 450,#     "model": "deepseek-local",#   "metadata": {#   "session_id": "session-001",#   "reply": "La capital de Francia es París.",# {# Respuesta esperada:  }' | jq .    "metadata": {"source": "ui"}    "session_id": "session-001",    "message": "¿Cuál es la capital de Francia?",  -d '{  -H "Content-Type: application/json" \  -H "X-VX11-Token: vx11-local-token" \curl -X POST http://127.0.0.1:8011/operator/chat \# Happy path: enviar mensaje```bash### Endpoint: `/operator/chat` (Fase F)**Caso:** Usuario envía un mensaje al Operator frontend. El backend consulta Switch para elegir modelo (local o CLI) y retorna respuesta.## Pattern: Simple Chat (via Switch → Local Model)---```curl -s http://127.0.0.1:8000/vx11/status | jq .# Gateway Status (includes context-7 TTL info)curl -s http://127.0.0.1:8011/operator/health | jq . 2>/dev/null || echo "operator backend not up"# Operator Backend APIcurl -s http://127.0.0.1:8002/switch/health | jq . 2>/dev/null || echo "switch not up"# Switch (IA Router)curl -s http://127.0.0.1:8001/madre/health | jq . 2>/dev/null || echo "madre not up"# Madre (Orchestrator)curl -s http://127.0.0.1:8000/health | jq .# Gateway (Tentáculo Link)```bashVerifica que los servicios están activos:## Quick Health Checks---**Objetivo:** Ejecutar flujos VX11 sin spawning masivo ni llamadas a modelos remotos costosos. Usar HTTP local, circuit breaker, y modelos locales cuando sea posible.on:
  push:
    branches: [main, develop, feature/**]
    paths-ignore:
      - 'docs/**'
      - 'logs/**'
      - '.copilot-audit/**'
      - '*.md'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - 'logs/**'
      - '.copilot-audit/**'
      - '*.md'

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: pip install pylint black
      - run: black --check tentaculo_link operator_backend 2>/dev/null || true
      - run: pylint tentaculo_link --disable=all --enable=E,F 2>/dev/null || true

  py_compile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: python -m compileall tentaculo_link operator_backend
        continue-on-error: false

  compose_validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          if command -v docker-compose &> /dev/null; then
            docker-compose config > /dev/null
            echo "✓ docker-compose.yml is valid"
          else
            echo "⚠️ docker-compose not available, skipping validation"
          fi
        continue-on-error: true

  frontend_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'operator_backend/frontend/package-lock.json'
      - run: cd operator_backend/frontend && npm ci
      - run: cd operator_backend/frontend && npm run type-check 2>/dev/null || echo "⚠️ No type-check script"
      - run: cd operator_backend/frontend && npm run build
        continue-on-error: true

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest pytest-asyncio
      - run: pytest tests/ -v --tb=short

  build:
    runs-on: ubuntu-latest
    needs: [lint, test, py_compile, frontend_build]
    steps:
      - uses: actions/checkout@v4
      - run: echo "✓ All validations passed"
