name: P11 Secret Scanning (TruffleHog + Detect-Secrets)

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main

jobs:
    trufflehog-scan:
        name: TruffleHog Secret Detection
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for TruffleHog

            - name: Run TruffleHog scan
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --json --fail

            - name: Upload scan results
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: trufflehog-results
                  path: trufflehog-results.json

    detect-secrets-scan:
        name: Detect-Secrets Baseline Check
        runs-on: ubuntu-latest
        permissions:
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            - name: Install detect-secrets
              run: pip install detect-secrets

            - name: Detect secrets
              run: |
                  detect-secrets scan \
                    --all-files \
                    --baseline .secrets.baseline \
                    --fail-on-detected-secrets \
                    2>&1 | tee detect-secrets-output.log

            - name: Report findings
              if: failure()
              run: |
                  echo "‚ùå Secrets detected in codebase!"
                  echo "Run locally: pre-commit run detect-secrets -a"
                  cat detect-secrets-output.log
                  exit 1

    env-vars-check:
        name: Environment Variables Leak Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check for exposed secrets in env files
              run: |
                  if grep -rE \
                    "(DEEPSEEK_API_KEY|OPENAI_API_KEY|TOKEN=|PASSWORD=|SECRET=)" \
                    .env* 2>/dev/null; then
                    echo "‚ùå ERROR: Secrets found in .env files!"
                    exit 1
                  else
                    echo "‚úì No exposed secrets in .env files"
                  fi

            - name: Check for hardcoded secrets in code
              run: |
                  if grep -r \
                    "sk-[a-zA-Z0-9]\{32\}" \
                    --include="*.py" \
                    --include="*.js" \
                    --include="*.yml" \
                    --include="*.yaml" \
                    --exclude-dir=.git \
                    --exclude-dir=node_modules \
                    .; then
                    echo "‚ùå ERROR: Hardcoded API keys detected!"
                    exit 1
                  else
                    echo "‚úì No hardcoded API keys found"
                  fi

    summary:
        name: Security Scan Summary
        runs-on: ubuntu-latest
        needs: [trufflehog-scan, detect-secrets-scan, env-vars-check]
        if: always()

        steps:
            - name: Summary
              run: |
                  echo "üîí P11 Secret Scanning Results:"
                  echo "- TruffleHog: ${{ needs.trufflehog-scan.result }}"
                  echo "- Detect-Secrets: ${{ needs.detect-secrets-scan.result }}"
                  echo "- Env Check: ${{ needs.env-vars-check.result }}"

                  if [ "${{ needs.trufflehog-scan.result }}" != "success" ] || \
                     [ "${{ needs.detect-secrets-scan.result }}" != "success" ] || \
                     [ "${{ needs.env-vars-check.result }}" != "success" ]; then
                    echo "‚ùå Security scan failed. Push blocked."
                    exit 1
                  else
                    echo "‚úÖ All security checks passed"
                  fi
