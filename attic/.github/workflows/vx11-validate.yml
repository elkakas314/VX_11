name: VX11 Validate (PR & Feature Branches)

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - "feature/**"
  workflow_dispatch:

concurrency:
  group: vx11-validate-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  validate_python:
    name: Python Syntax & Imports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Python Syntax Check
        run: |
          python -m compileall tentaculo_link operator_backend config 2>&1 | tee /tmp/syntax.log
          if grep -q "SyntaxError" /tmp/syntax.log; then
            echo "❌ Python syntax errors detected"
            exit 1
          fi
          echo "✓ Python syntax OK"

      - name: Cross-Module Import Check
        run: |
          VIOLATIONS=$(grep -r "^from tentaculo_link import\|^from madre import\|^from switch import\|^from hermes import" \
            --include="*.py" \
            tentaculo_link/ madre/ switch/ 2>/dev/null | grep -v test | wc -l)
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo "❌ Found $VIOLATIONS cross-module imports (should be 0)"
            grep -r "^from tentaculo_link import\|^from madre import\|^from switch import\|^from hermes import" \
              --include="*.py" \
              tentaculo_link/ madre/ switch/ 2>/dev/null | head -10
            exit 1
          fi
          echo "✓ No cross-module imports"

  validate_docker:
    name: Docker Configuration
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Docker Compose Config Check
        run: |
          if ! command -v docker-compose &> /dev/null; then
            echo "⚠️ Docker not available (skipping)"
            exit 0
          fi
          docker-compose config > /dev/null 2>&1 && echo "✓ Docker config valid" || {
            echo "❌ Docker config invalid"
            exit 1
          }

  validate_security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan for Secrets
        run: |
          SECRETS=$(grep -r "password=\|token=\|api_key=\|secret=" --include="*.py" \
            --include="*.js" --include="*.ts" \
            . 2>/dev/null | \
            grep -v "\.env\|tokens.env\|settings.py\|deepseek.py\|\.git" || echo "")
          if [ -n "$SECRETS" ]; then
            echo "⚠️ Possible secrets detected:"
            echo "$SECRETS" | head -5
            # Don't block, just warn (might be false positives)
          else
            echo "✓ No obvious secrets detected"
          fi

      - name: Check .gitignore Compliance
        run: |
          TRACKED=$(git ls-files | grep -E "node_modules/|dist/|\.venv/|__pycache__|\.pytest_cache" || echo "")
          if [ -n "$TRACKED" ]; then
            echo "❌ Ignored files are tracked (should be in .gitignore):"
            echo "$TRACKED"
            exit 1
          fi
          echo "✓ .gitignore compliant"

  validate_frontend:
    name: Frontend Type Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "operator_backend/frontend/package-lock.json"

      - name: Frontend Dependencies
        run: |
          if [ -f "operator_backend/frontend/package.json" ]; then
            cd operator_backend/frontend
            npm ci --prefer-offline --no-audit 2>&1 | tail -5
          else
            echo "⚠️ No frontend package.json (skipping)"
          fi

      - name: TypeScript Check
        run: |
          if [ -f "operator_backend/frontend/package.json" ]; then
            cd operator_backend/frontend
            npm run type-check 2>&1 || echo "⚠️ Type check not available or failed (non-blocking)"
          fi

  vx11_validate:
    name: VX11 Validate Runner
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Run VX11 Validator
        run: |
          if [ -f scripts/vx11_workflow_runner.py ]; then
            python scripts/vx11_workflow_runner.py validate
          else
            echo "⚠️ vx11_workflow_runner.py not found"
          fi
        continue-on-error: true

      - name: Upload Validate Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: vx11-validate-report
          path: docs/audit/VX11_VALIDATE_REPORT.md
        continue-on-error: true

  results:
    name: Validation Results
    runs-on: ubuntu-latest
    needs:
      [
        validate_python,
        validate_docker,
        validate_security,
        validate_frontend,
        vx11_validate,
      ]
    if: always()
    steps:
      - name: Check Results
        run: |
          PYTHON_STATUS="${{ needs.validate_python.result }}"
          DOCKER_STATUS="${{ needs.validate_docker.result }}"
          SECURITY_STATUS="${{ needs.validate_security.result }}"
          FRONTEND_STATUS="${{ needs.validate_frontend.result }}"
          VX11_STATUS="${{ needs.vx11_validate.result }}"

          echo "=== VX11 Validation Summary ==="
          echo "Python:   $PYTHON_STATUS"
          echo "Docker:   $DOCKER_STATUS"
          echo "Security: $SECURITY_STATUS"
          echo "Frontend: $FRONTEND_STATUS"
          echo "VX11:     $VX11_STATUS"

          if [ "$PYTHON_STATUS" = "failure" ]; then
            echo "❌ VALIDATION FAILED: Python syntax or imports"
            exit 1
          fi
          if [ "$SECURITY_STATUS" = "failure" ]; then
            echo "❌ VALIDATION FAILED: Security checks"
            exit 1
          fi

          echo ""
          echo "✅ VALIDATION PASSED (safe for PR)"
